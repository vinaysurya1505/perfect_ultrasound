<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Admin Panel</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link { transition: all 0.2s ease-in-out; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #3b82f6; color: white; }
        .modal-bg { background-color: rgba(0,0,0,0.5); z-index: 50; transition: opacity 0.3s ease-in-out; }
        .modal-content { max-height: 90vh; transition: transform 0.3s ease-in-out; }
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media print {
            body * { visibility: hidden; }
            #pdf-preview, #pdf-preview * { visibility: visible; }
            #pdf-preview { position: absolute; left: 0; top: 0; width: 100%; }
        }
        /* For custom scrollbars */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container"></div>

    <!-- Hidden element for rendering PDF content -->
    <div id="pdf-preview" class="hidden fixed -left-[2000px] top-0 w-[800px] bg-white text-black p-8 font-sans"></div>

    <!-- Bill Creation Success Modal -->
    <div id="bill-success-modal" class="fixed inset-0 modal-bg hidden flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center modal-content transform scale-95">
            <div class="flex justify-center items-center mx-auto h-16 w-16 rounded-full bg-green-100 mb-4">
                <svg class="h-10 w-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Bill Created Successfully!</h3>
            <p id="bill-success-message" class="mb-6 text-gray-600"></p>
            <div class="flex flex-col sm:flex-row justify-center gap-3">
                 <button id="bill-success-download-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">Download PDF</button>
                 <button id="bill-success-print-btn" class="w-full px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors">Print</button>
                 <button id="bill-success-close-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Generic Modal for Alerts and Confirmations -->
    <div id="generic-modal" class="fixed inset-0 modal-bg hidden flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl modal-content transform scale-95">
            <h3 id="generic-modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <div id="generic-modal-message" class="mb-6 text-gray-600"></div>
            <div id="generic-modal-buttons" class="flex justify-end gap-3">
                <!-- Buttons are dynamically injected here -->
            </div>
        </div>
    </div>


    <script>
    // ========================================================================
    // --- 1. FIREBASE & APP INITIALIZATION ---
    // ========================================================================
    document.addEventListener('DOMContentLoaded', () => {
        fetch('/api/config')
            .then(response => response.json())
            .then(firebaseConfig => {
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const { Timestamp, FieldValue } = firebase.firestore;

        const appContainer = document.getElementById('app-container');
        const state = {
            user: null,
            currentPage: 'home',
            listeners: [],
        };

        // ========================================================================
        // --- 2. MODAL & NOTIFICATION UTILITIES ---
        // ========================================================================
        const genericModal = document.getElementById('generic-modal');
        const genericModalTitle = document.getElementById('generic-modal-title');
        const genericModalMessage = document.getElementById('generic-modal-message');
        const genericModalButtons = document.getElementById('generic-modal-buttons');

        function showModal(title, message, buttons = [{ text: 'OK', class: 'bg-blue-600', action: hideModal }]) {
            genericModalTitle.textContent = title;
            genericModalMessage.textContent = message;
            genericModalButtons.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `px-4 py-2 text-white font-semibold rounded-lg transition-colors ${btnInfo.class}`;
                button.onclick = () => {
                    if (btnInfo.action) btnInfo.action();
                    hideModal();
                };
                genericModalButtons.appendChild(button);
            });
            genericModal.classList.remove('hidden');
            setTimeout(() => genericModal.querySelector('.modal-content').classList.remove('scale-95'), 10);
        }

        function hideModal() {
            const modal = document.querySelector('.modal-bg:not(.hidden)');
            if (modal) {
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }
        
        function showConfirmationModal(title, message, onConfirm) {
            showModal(title, message, [
                { text: 'Cancel', class: 'bg-gray-500 hover:bg-gray-600', action: hideModal },
                { text: 'Confirm', class: 'bg-red-600 hover:bg-red-700', action: onConfirm }
            ]);
        }

        // --- Bill Success Modal Logic ---
        const billSuccessModal = document.getElementById('bill-success-modal');
        function showBillSuccessModal(billId, billNumber) {
            document.getElementById('bill-success-message').textContent = `Bill #${billNumber} is now ready.`;
            
            document.getElementById('bill-success-download-btn').onclick = () => generateAndDownloadPDF(billId, 'download');
            document.getElementById('bill-success-print-btn').onclick = () => generateAndDownloadPDF(billId, 'print');
            document.getElementById('bill-success-close-btn').onclick = hideModal;

            billSuccessModal.classList.remove('hidden');
            setTimeout(() => billSuccessModal.querySelector('.modal-content').classList.remove('scale-95'), 10);
        }

        // ========================================================================
        // --- 3. AUTHENTICATION LOGIC ---
        // ========================================================================
        auth.onAuthStateChanged(user => {
            state.listeners.forEach(unsubscribe => unsubscribe());
            state.listeners = [];
            
            if (user) {
                state.user = user;
                if(state.currentPage === 'login' || state.currentPage === 'home') {
                    state.currentPage = 'dashboard';
                }
            } else {
                state.user = null;
                state.currentPage = 'home';
            }
            renderApp();
        });

        function handleLogin(email, password) {
            const errorEl = document.getElementById('login-error');
            const button = document.querySelector('#login-form button[type="submit"]');
            errorEl.textContent = '';
            button.disabled = true;
            button.innerHTML = '<span class="spinner h-5 w-5 mx-auto border-2"></span>';
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    errorEl.textContent = error.message || "Failed to login. Please check your credentials.";
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerHTML = 'Sign In';
                });
        }

        function handleLogout() {
            auth.signOut();
        }
        
        // ========================================================================
        // --- 4. UI RENDERING & ROUTING ---
        // ========================================================================
        function renderApp() {
            if (!state.user && state.currentPage !== 'home' && state.currentPage !== 'login') {
                state.currentPage = 'home';
            }
            switch (state.currentPage) {
                case 'home': renderHomePage(); break;
                case 'login': renderLoginPage(); break;
                case 'dashboard': renderAdminLayout('Dashboard', renderDashboard); break;
                case 'billing': renderAdminLayout('Billing', initializeBillingPage); break;
                case 'tests': renderAdminLayout('Manage Tests', initializeTestsPage); break;
                case 'doctors': renderAdminLayout('Manage Doctors', initializeDoctorsPage); break;
                case 'expenditures': renderAdminLayout('Expenditures', initializeExpendituresPage); break;
                        case 'tasks': renderAdminLayout('Tasks', initializeTasksPage); break;
                case 'reports': renderAdminLayout('Financial Reports', renderReportsPage); break;
                        case 'commissions': renderAdminLayout('Commission Management', renderCommissionManagementPage); break;
                        case 'transactions': renderAdminLayout('Transactions', renderTransactionsPage); break;
                        case 'developer': renderAdminLayout('Developer', renderDeveloperPage); break;
                        default: renderHomePage();
            }
        }
        
        function navigate(page) {
            state.currentPage = page;
            renderApp();
        }

        // ========================================================================
        // --- 5. HTML TEMPLATES & COMPONENTS ---
        // ========================================================================
        
        function renderHomePage() {
            appContainer.innerHTML = `
                <div class="min-h-screen bg-white">
                    <header class="absolute top-0 left-0 right-0 z-10 bg-gradient-to-r from-blue-700 via-blue-500 to-blue-400 shadow-md">
                        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                            <h1 class="text-xl md:text-2xl font-bold text-white drop-shadow">Perfect Diagnostic Centre</h1>
                            <button id="go-to-login-nav" class="px-5 py-2 bg-white text-blue-700 font-semibold rounded-lg shadow-md hover:bg-blue-100 transition duration-300">
                                Admin Login
                            </button>
                        </nav>
                    </header>
                    <main>
                        <section 
                            class="relative h-screen flex items-center justify-center bg-cover bg-center" 
                            style="background-image: url('https://images.unsplash.com/photo-1576091160550-2173dba999ef?q=80&w=2070&auto=format&fit=crop');">
                            <div class="absolute inset-0 bg-black bg-opacity-50"></div>
                            <div class="relative container mx-auto px-6 text-center text-white">
                                <h2 class="text-4xl md:text-6xl font-extrabold leading-tight tracking-tight">Your Partner in Accurate Diagnostics</h2>
                                <p class="mt-4 text-lg md:text-xl max-w-2xl mx-auto text-gray-200">State-of-the-art technology ensuring patient care and satisfaction.</p>
                            </div>
                        </section>
                        <!-- Feature Cards Section -->
                        <section class="py-16 bg-white">
                            <div class="container mx-auto px-6">
                                <h3 class="text-3xl font-bold text-center text-blue-700 mb-10">Why Choose Us?</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 justify-center">
                                    <div class="bg-blue-50 rounded-xl shadow-lg p-6 flex flex-col items-center">
                                        <div class="bg-blue-100 text-blue-700 rounded-full p-3 mb-4">
                                            <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4" /></svg>
                                        </div>
                                        <h4 class="font-semibold text-lg mb-2">Accurate Results</h4>
                                        <p class="text-gray-600 text-center">Precision diagnostics for reliable health decisions.</p>
                                    </div>
                                    <div class="bg-blue-50 rounded-xl shadow-lg p-6 flex flex-col items-center">
                                        <div class="bg-blue-100 text-blue-700 rounded-full p-3 mb-4">
                                            <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01" /></svg>
                                        </div>
                                        <h4 class="font-semibold text-lg mb-2">Modern Machines</h4>
                                        <p class="text-gray-600 text-center">Latest technology for advanced testing and imaging.</p>
                                    </div>
                                    <div class="bg-blue-50 rounded-xl shadow-lg p-6 flex flex-col items-center">
                                        <div class="bg-blue-100 text-blue-700 rounded-full p-3 mb-4">
                                            <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                                        </div>
                                        <h4 class="font-semibold text-lg mb-2">Trusted Experts</h4>
                                        <p class="text-gray-600 text-center">Experienced professionals for quality care.</p>
                                    </div>
                                    <div class="bg-blue-50 rounded-xl shadow-lg p-6 flex flex-col items-center">
                                        <div class="bg-blue-100 text-blue-700 rounded-full p-3 mb-4">
                                            <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3" /></svg>
                                        </div>
                                        <h4 class="font-semibold text-lg mb-2">Quick Turnaround</h4>
                                        <p class="text-gray-600 text-center">Fast reporting for timely treatment decisions.</p>
                                    </div>
                                    <div class="bg-blue-50 rounded-xl shadow-lg p-6 flex flex-col items-center">
                                        <div class="bg-blue-100 text-blue-700 rounded-full p-3 mb-4">
                                            <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0-1.104.896-2 2-2s2 .896 2 2-.896 2-2 2-2-.896-2-2z" /></svg>
                                        </div>
                                        <h4 class="font-semibold text-lg mb-2">Affordable Pricing</h4>
                                        <p class="text-gray-600 text-center">Competitive rates for all diagnostic services.</p>
                                    </div>
                                    <div class="bg-blue-50 rounded-xl shadow-lg p-6 flex flex-col items-center">
                                        <div class="bg-blue-100 text-blue-700 rounded-full p-3 mb-4">
                                            <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a5 5 0 00-10 0v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2z" /></svg>
                                        </div>
                                        <h4 class="font-semibold text-lg mb-2">Patient-Centric Care</h4>
                                        <p class="text-gray-600 text-center">Compassionate service for every patient.</p>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <section class="py-20 bg-gray-50">
                            <div class="container mx-auto px-6 text-center">
                                <h3 class="text-3xl font-bold text-gray-800 mb-12">Get In Touch</h3>
                                <div class="flex flex-wrap justify-center gap-12">
                                    <div class="text-center max-w-sm">
                                        <div class="flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 text-blue-600 mx-auto mb-4">
                                            <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                        </div>
                                        <h4 class="text-xl leading-6 font-medium text-gray-900">Our Location</h4>
                                        <p class="mt-2 text-base text-gray-600">Kotwa bazar, Nebua Naurangiya Road, Minar Pul, Kotwa Kalan, Kushinagar, Uttar Pradesh, 274305</p>
                                    </div>
                                    <div class="text-center max-w-sm">
                                        <div class="flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 text-blue-600 mx-auto mb-4">
                                            <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                                        </div>
                                        <h4 class="text-xl leading-6 font-medium text-gray-900">Phone & Email</h4>
                                                <p class="mt-2 text-base text-gray-600">+91 9838104111<br>+91 9616434212<br>perfectdiagnostic@gmail.com<br>GSTIN: 09BHIPT2225A1ZK</p>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </main>
                    <footer class="bg-gray-800 text-white">
                        <div class="container mx-auto px-6 py-8 text-center">
                            <p>&copy; ${new Date().getFullYear()} Perfect Diagnostic and Ultrasound Centre. All Rights Reserved.</p>
                        </div>
                    </footer>
                </div>
            `;
            document.getElementById('go-to-login-nav').onclick = () => navigate('login');
        }

        function renderLoginPage() {
            appContainer.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center">
                    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl">
                        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Admin Login</h2>
                        <form id="login-form">
                            <div class="mb-4">
                                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <p id="login-error" class="text-red-500 text-sm mb-4 h-5"></p>
                            <button type="submit" class="w-full py-2.5 px-4 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors flex justify-center items-center">Sign In</button>
                            <button id="back-to-home" type="button" class="mt-4 w-full text-center text-sm text-gray-600 hover:text-blue-600">Back to Home</button>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('login-form').onsubmit = (e) => {
                e.preventDefault();
                handleLogin(e.target.email.value, e.target.password.value);
            };
            document.getElementById('back-to-home').onclick = () => navigate('home');
        }

        function renderAdminLayout(title, contentRenderer) {
            appContainer.innerHTML = `
                <div class="flex h-screen bg-gray-100">
                    <aside class="w-64 bg-gray-800 text-white flex flex-col hidden md:flex">
                                <div class="h-16 flex items-center justify-center text-2xl font-bold">Clinic Admin</div>
                        <nav class="flex-1 px-2 py-4 space-y-2">
                            ${SidebarItem('dashboard', 'Dashboard')}
                            ${SidebarItem('billing', 'Billing')}
                            ${SidebarItem('tests', 'Tests')}
                            ${SidebarItem('doctors', 'Doctors')}
                            ${SidebarItem('expenditures', 'Expenditure')}
                                    ${SidebarItem('tasks', 'Tasks')}
                                    ${SidebarItem('reports', 'Financial Report')}
                                    ${SidebarItem('commissions', 'Commission Management')}
                                    ${SidebarItem('transactions', 'Transactions')}
                                    ${SidebarItem('developer', 'Developer')}
                        </nav>
                        <div class="p-4">
                            <button id="logout-btn" class="w-full py-2 px-4 text-left rounded-md sidebar-link bg-red-600 hover:bg-red-700 text-white font-semibold">Sign Out</button>
                        </div>
                    </aside>
                    <main class="flex-1 flex flex-col overflow-hidden">
                        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6">
                            <h1 class="text-2xl font-semibold text-gray-800">${title}</h1>
                        </header>
                        <div id="page-content" class="flex-1 overflow-x-hidden overflow-y-auto p-4 sm:p-6 bg-gray-50"></div>
                    </main>
                </div>
            `;
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    navigate(e.currentTarget.dataset.page);
                };
            });
            document.getElementById('logout-btn').onclick = handleLogout;
            
            contentRenderer();
        }
        
        function SidebarItem(page, text) {
            const isActive = state.currentPage === page ? 'active' : '';
            return `<a href="#" data-page="${page}" class="nav-link block py-2.5 px-4 rounded-md sidebar-link ${isActive}">${text}</a>`;
        }

        // ========================================================================
        // --- 6. GENERIC CRUD PAGE LOGIC ---
        // ========================================================================

        function createCrudPage(collectionName, title, formFields, tableHeaders, renderRow) {
            const content = document.getElementById('page-content');
            let editingId = null;

            const formInputs = formFields.map(f => `
                <div class="mb-4">
                    <label for="${f.id}" class="block text-sm font-medium text-gray-700">${f.label}</label>
                    <input type="${f.type}" id="${f.id}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
            `).join('');
            
            // Add image upload field for expenditures
            const imageUploadField = collectionName === 'expenditures' ? `
                <div class="mb-4">
                    <label for="proof-image" class="block text-sm font-medium text-gray-700 mb-1">Proof Image (Optional)</label>
                    <input type="file" id="proof-image" accept="image/jpeg,image/jpg,image/png" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <p class="mt-1 text-xs text-gray-500">Supported formats: JPEG, JPG, PNG</p>
                    <div id="image-preview-container" class="mt-2 hidden">
                        <img id="image-preview" src="" alt="Preview" class="max-w-full h-32 object-contain border rounded">
                        <button type="button" id="remove-image-btn" class="mt-2 text-red-600 hover:text-red-800 text-sm">Remove Image</button>
                    </div>
                </div>
            ` : '';

            const tableHeaderRow = tableHeaders.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('');

            content.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 id="form-title" class="text-xl font-bold leading-6 text-gray-900 mb-4">Add New ${title}</h3>
                        <form id="crud-form">
                            ${formInputs}
                            ${imageUploadField}
                            <div class="flex items-center gap-4 mt-6">
                                <button type="submit" id="submit-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Save ${title}</button>
                                <button type="button" id="cancel-btn" class="px-4 py-2 text-gray-600 hover:text-gray-900 font-semibold hidden">Cancel</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                                <div class="px-6 py-4 border-b border-gray-200">
                                    <div class="relative">
                                        <input type="text" id="search-input" placeholder="Search ${title.toLowerCase()}s..." class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>${tableHeaderRow}</tr>
                                </thead>
                                <tbody id="crud-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            const form = document.getElementById('crud-form');
            const tableBody = document.getElementById('crud-table-body');
            const formTitle = document.getElementById('form-title');
            const submitBtn = document.getElementById('submit-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            
            // Image preview functionality for expenditures
            if (collectionName === 'expenditures') {
                const proofImageInput = document.getElementById('proof-image');
                const imagePreview = document.getElementById('image-preview');
                const imagePreviewContainer = document.getElementById('image-preview-container');
                const removeImageBtn = document.getElementById('remove-image-btn');
                
                if (proofImageInput && imagePreview && imagePreviewContainer && removeImageBtn) {
                    proofImageInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                imagePreview.src = e.target.result;
                                imagePreviewContainer.classList.remove('hidden');
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                    
                    removeImageBtn.addEventListener('click', () => {
                        proofImageInput.value = '';
                        imagePreviewContainer.classList.add('hidden');
                        imagePreview.src = '';
                    });
                }
            }

            function resetForm() {
                form.reset();
                editingId = null;
                formTitle.textContent = `Add New ${title}`;
                submitBtn.textContent = `Save ${title}`;
                cancelBtn.classList.add('hidden');
                
                // Reset image preview
                if (collectionName === 'expenditures') {
                    const imagePreviewContainer = document.getElementById('image-preview-container');
                    if (imagePreviewContainer) {
                        imagePreviewContainer.classList.add('hidden');
                    }
                }
            }

            cancelBtn.onclick = resetForm;
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                const data = {};
                formFields.forEach(f => {
                    const input = document.getElementById(f.id);
                    data[f.key] = f.type === 'number' ? parseFloat(input.value) : input.value;
                });

                try {
                    // Handle image upload for expenditures
                    if (collectionName === 'expenditures') {
                        const proofImageInput = document.getElementById('proof-image');
                        const file = proofImageInput?.files[0];
                        
                        if (file) {
                            // Sanitize filename to avoid CORS issues
                            const sanitizedName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                            const timestamp = Date.now();
                            const fileName = `${timestamp}_${sanitizedName}`;
                            
                            try {
                                // Convert image to base64 for storage in Firestore
                                const reader = new FileReader();
                                await new Promise((resolve, reject) => {
                                    reader.onload = (e) => {
                                        data.proofImageUrl = e.target.result;
                                        data.proofImageName = fileName;
                                        resolve();
                                    };
                                    reader.onerror = reject;
                                    reader.readAsDataURL(file);
                                });
                            } catch (uploadError) {
                                console.error('Image processing failed:', uploadError);
                                // Continue without image if processing fails
                                showModal('Image Processing Warning', 'Could not process proof image, but the expenditure was saved.');
                            }
                        }
                    }
                    
                    if (editingId) {
                        await db.collection(collectionName).doc(editingId).update(data);
                    } else {
                        if (collectionName === 'doctors') data.commissionBalance = 0;
                        if (collectionName === 'expenditures') data.date = Timestamp.now();
                        await db.collection(collectionName).add(data);
                    }
                    resetForm();
                } catch (error) {
                    console.error("Error saving document: ", error);
                    showModal('Error', "Failed to save data. Please check the console for details.");
                }
            };

            const query = db.collection(collectionName);
                    let allDocs = [];
                    let filteredDocs = [];

                    function renderTable(docs) {
                        tableBody.innerHTML = '';
                    if (docs.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="${tableHeaders.length}" class="text-center py-10 text-gray-500">No ${title}s found.</td></tr>`;
                        return;
                    }
                        
                    docs.forEach(doc => {
                        const row = tableBody.insertRow();
                        row.innerHTML = renderRow(doc.id, doc.data());
                        
                        row.querySelector('.edit-btn').onclick = () => {
                            editingId = doc.id;
                            const data = doc.data();
                            formFields.forEach(f => {
                                document.getElementById(f.id).value = data[f.key] || '';
                            });
                            
                            // Load existing image if editing expenditure with image
                            if (collectionName === 'expenditures' && data.proofImageUrl) {
                                const imagePreview = document.getElementById('image-preview');
                                const imagePreviewContainer = document.getElementById('image-preview-container');
                                if (imagePreview && imagePreviewContainer) {
                                    imagePreview.src = data.proofImageUrl;
                                    imagePreviewContainer.classList.remove('hidden');
                                }
                            }
                            
                            formTitle.textContent = `Edit ${title}`;
                            submitBtn.textContent = `Update ${title}`;
                            cancelBtn.classList.remove('hidden');
                            form.scrollIntoView({ behavior: 'smooth' });
                        };

                        row.querySelector('.delete-btn').onclick = () => {
                             showConfirmationModal('Confirm Deletion', `Are you sure you want to delete this ${title}? This action cannot be undone.`, async () => {
                                await db.collection(collectionName).doc(doc.id).delete();
                            });
                        };
                    });
                    }

                    function filterData(searchTerm) {
                        if (!searchTerm.trim()) {
                            filteredDocs = [...allDocs];
                        } else {
                            filteredDocs = allDocs.filter(doc => {
                                const data = doc.data();
                                return formFields.some(field => {
                                    const value = (data[field.key] || '').toString().toLowerCase();
                                    return value.includes(searchTerm.toLowerCase());
                                });
                            });
                        }
                        
                        // Sort filtered data
                        if (collectionName === 'expenditures') {
                            filteredDocs.sort((a, b) => (b.data().date?.toMillis() || 0) - (a.data().date?.toMillis() || 0));
                        } else if (formFields.length > 0) {
                            const sortKey = formFields[0].key;
                            filteredDocs.sort((a, b) => (a.data()[sortKey] || '').toString().localeCompare((b.data()[sortKey] || '').toString()));
                        }
                        
                        renderTable(filteredDocs);
                    }
                    
                    const unsubscribe = query.onSnapshot(snapshot => {
                        tableBody.innerHTML = `<tr><td colspan="${tableHeaders.length}" class="text-center py-10"><div class="spinner h-8 w-8 mx-auto border-4"></div></td></tr>`;
                        
                        allDocs = snapshot.docs;
                        filteredDocs = [...allDocs];
                        
                        // Client-side sorting
                        if (collectionName === 'expenditures') {
                            allDocs.sort((a, b) => (b.data().date?.toMillis() || 0) - (a.data().date?.toMillis() || 0));
                        } else if (formFields.length > 0) {
                            const sortKey = formFields[0].key;
                            allDocs.sort((a, b) => (a.data()[sortKey] || '').toString().localeCompare((b.data()[sortKey] || '').toString()));
                        }

                        setTimeout(() => {
                            filterData(document.getElementById('search-input').value);
                }, 300);
            });

                    // Add search functionality
                    document.getElementById('search-input').addEventListener('input', (e) => {
                        filterData(e.target.value);
                    });
            state.listeners.push(unsubscribe);
        }

        // ========================================================================
        // --- 7. CRUD PAGE IMPLEMENTATIONS ---
        // ========================================================================

        function initializeTestsPage() {
            createCrudPage('tests', 'Test',
                [{ id: 'test-name', label: 'Test Name', type: 'text', key: 'name' }, { id: 'test-price', label: 'Price (₹)', type: 'number', key: 'price' }],
                ['Name', 'Price', 'Actions'],
                (id, data) => `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${data.name || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">₹${(Number(data.price) || 0).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                        <button class="delete-btn text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `
            );
        }

        function initializeDoctorsPage() {
             createCrudPage('doctors', 'Doctor',
                [{ id: 'doctor-name', label: 'Doctor Name', type: 'text', key: 'name' }, { id: 'doctor-commission', label: 'Commission (%)', type: 'number', key: 'commissionPercent' }],
                ['Name', 'Commission %', 'Commission Balance', 'Actions'],
                (id, data) => `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${data.name || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${data.commissionPercent || 0}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-800">₹${(Number(data.commissionBalance) || 0).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                        <button class="delete-btn text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `
            );
        }

        function initializeExpendituresPage() {
             createCrudPage('expenditures', 'Expenditure',
                [{ id: 'exp-description', label: 'Description', type: 'text', key: 'description' }, { id: 'exp-amount', label: 'Amount (₹)', type: 'number', key: 'amount' }],
                ['Date', 'Description', 'Amount', 'Proof', 'Actions'],
                (id, data) => `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${data.date ? data.date.toDate().toLocaleDateString() : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${data.description || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-red-600">₹${(Number(data.amount) || 0).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${data.proofImageUrl ? `
                            <button onclick="showProofImage('${data.proofImageUrl}')" class="text-blue-600 hover:text-blue-800 hover:underline">View</button>
                        ` : 'No image'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                        <button class="delete-btn text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `
            );
        }

                function initializeTasksPage() {
                    const content = document.getElementById('page-content');
                    let editingId = null;

                    const formFields = [
                        { id: 'task-description', label: 'Task Description', type: 'text', key: 'description' },
                        { id: 'task-amount', label: 'Amount (₹)', type: 'number', key: 'amount' }
                    ];

                    const formInputs = formFields.map(f => `
                        <div class="mb-4">
                            <label for="${f.id}" class="block text-sm font-medium text-gray-700">${f.label}</label>
                            <input type="${f.type}" id="${f.id}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                    `).join('');

                    content.innerHTML = `
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h2 id="form-title" class="text-lg font-semibold text-gray-800 mb-4">Add New Task</h2>
                                <form id="task-form" class="space-y-4">
                                    ${formInputs}
                                    <div class="flex gap-4">
                                        <button type="submit" id="submit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Task</button>
                                        <button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 hidden">Cancel</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow overflow-hidden">
                                <div class="px-6 py-4 border-b border-gray-200">
                                    <h3 class="text-lg font-semibold text-gray-800">All Tasks</h3>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="task-table-body" class="bg-white divide-y divide-gray-200">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;

                    const form = document.getElementById('task-form');
                    const formTitle = document.getElementById('form-title');
                    const submitBtn = document.getElementById('submit-btn');
                    const cancelBtn = document.getElementById('cancel-btn');

                    function resetForm() {
                        form.reset();
                        editingId = null;
                        formTitle.textContent = 'Add New Task';
                        submitBtn.textContent = 'Save Task';
                        cancelBtn.classList.add('hidden');
                    }

                    cancelBtn.onclick = resetForm;
                    
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        const data = {};
                        formFields.forEach(f => {
                            const input = document.getElementById(f.id);
                            data[f.key] = f.type === 'number' ? parseFloat(input.value) : input.value;
                        });

                        try {
                            if (editingId) {
                                await db.collection('tasks').doc(editingId).update(data);
                            } else {
                                data.date = Timestamp.now();
                                data.status = 'pending';
                                data.paidAt = null;
                                await db.collection('tasks').add(data);
                            }
                            resetForm();
                            loadTasks();
                        } catch (error) {
                            console.error("Error saving task: ", error);
                            showModal('Error', "Failed to save task. Please check the console for details.");
                        }
                    };

                    function renderTable(tasks) {
                        const tbody = document.getElementById('task-table-body');
                        tbody.innerHTML = '';
                        
                        tasks.forEach(task => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${task.date ? task.date.toDate().toLocaleDateString() : 'N/A'}</td>
                                <td class="px-6 py-4 text-sm text-gray-800">${task.description || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-600">₹${(Number(task.amount) || 0).toFixed(2)}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${task.status === 'paid' ? 
                                        '<span class="px-2 py-1 rounded text-xs font-semibold bg-green-100 text-green-700">Paid</span>' : 
                                        '<span class="px-2 py-1 rounded text-xs font-semibold bg-orange-100 text-orange-700">Pending</span>'
                                    }
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4">
                                    ${task.status === 'paid' ? 
                                        '<span class="text-gray-400 text-sm">Completed</span>' :
                                        `
                                            <button class="edit-btn text-indigo-600 hover:text-indigo-900" data-id="${task.id}">Edit</button>
                                            <button class="mark-paid-btn text-green-600 hover:text-green-900" data-id="${task.id}">Mark as Paid</button>
                                            <button class="delete-btn text-red-600 hover:text-red-900" data-id="${task.id}">Delete</button>
                                        `
                                    }
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });

                        // Add event listeners
                        tbody.querySelectorAll('.edit-btn').forEach(btn => {
                            btn.onclick = () => editTask(btn.dataset.id);
                        });
                        
                        tbody.querySelectorAll('.mark-paid-btn').forEach(btn => {
                            btn.onclick = () => markAsPaid(btn.dataset.id);
                        });
                        
                        tbody.querySelectorAll('.delete-btn').forEach(btn => {
                            btn.onclick = () => deleteTask(btn.dataset.id);
                        });
                    }

                    async function editTask(id) {
                        try {
                            const doc = await db.collection('tasks').doc(id).get();
                            if (doc.exists) {
                                const data = doc.data();
                                editingId = id;
                                formTitle.textContent = 'Edit Task';
                                submitBtn.textContent = 'Update Task';
                                cancelBtn.classList.remove('hidden');
                                
                                document.getElementById('task-description').value = data.description || '';
                                document.getElementById('task-amount').value = data.amount || '';
                            }
                        } catch (error) {
                            console.error("Error loading task: ", error);
                            showModal('Error', "Failed to load task details.");
                        }
                    }

                    async function markAsPaid(id) {
                        showConfirmationModal('Mark as Paid', 'Are you sure you want to mark this task as paid? Once marked, it cannot be edited or deleted.', async () => {
                            try {
                                await db.collection('tasks').doc(id).update({
                                    status: 'paid',
                                    paidAt: Timestamp.now()
                                });
                                loadTasks();
                                showModal('Success', 'Task marked as paid successfully!');
                            } catch (error) {
                                console.error("Error marking task as paid: ", error);
                                showModal('Error', "Failed to mark task as paid.");
                            }
                        });
                    }

                    async function deleteTask(id) {
                        showConfirmationModal('Delete Task', 'Are you sure you want to delete this task? This action cannot be undone.', async () => {
                            try {
                                await db.collection('tasks').doc(id).delete();
                                loadTasks();
                                showModal('Success', 'Task deleted successfully!');
                            } catch (error) {
                                console.error("Error deleting task: ", error);
                                showModal('Error', "Failed to delete task.");
                            }
                        });
                    }

                    async function loadTasks() {
                        try {
                            const snapshot = await db.collection('tasks').orderBy('date', 'desc').get();
                            const tasks = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            renderTable(tasks);
                        } catch (error) {
                            console.error("Error loading tasks: ", error);
                            showModal('Error', "Failed to load tasks.");
                        }
                    }

                    // Load tasks on page initialization
                    loadTasks();
                }

                // ========================================================================
                // --- 7. DEVELOPER PAGE LOGIC ---
                // ========================================================================
                function renderDeveloperPage() {
                    const content = document.getElementById('page-content');
                    content.innerHTML = `
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                                <!-- Header -->
                                <div class="bg-gradient-to-r from-blue-600 to-blue-500 px-8 py-12 text-white">
                                    <div class="flex items-center gap-4 mb-6">
                                        <div class="w-16 h-16 bg-white bg-opacity-20 rounded-xl flex items-center justify-center text-2xl font-bold">
                                            WC
                                        </div>
                                        <div>
                                            <h1 class="text-3xl font-bold">WebCore Analytics</h1>
                                            <p class="text-blue-100 text-lg">Building digital and data-driven futures</p>
                                        </div>
                                    </div>
                                    <p class="text-blue-100 text-lg leading-relaxed">
                                        Website development and data analysis for small & medium businesses. Based in Shahdara, Delhi.
                                    </p>
                                </div>

                                <!-- Main Content -->
                                <div class="p-8">
                                    <!-- Hero Section -->
                                    <div class="mb-12">
                                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Website development & data analysis for small and medium businesses</h2>
                                        <p class="text-gray-600 text-lg leading-relaxed mb-6">
                                            We build modern websites and turn your business data into clear, actionable insights so you can make better decisions and grow with confidence.
                                        </p>
                                        
                                        <!-- Service Cards -->
                                        <div class="grid md:grid-cols-3 gap-6 mb-8">
                                            <div class="bg-blue-50 p-6 rounded-xl border border-blue-100">
                                                <h3 class="text-xl font-semibold text-gray-800 mb-3">Web Development</h3>
                                                <p class="text-gray-600">Responsive websites, e-commerce, CMS, landing pages and performance optimization.</p>
                                            </div>
                                            <div class="bg-green-50 p-6 rounded-xl border border-green-100">
                                                <h3 class="text-xl font-semibold text-gray-800 mb-3">Data Analysis</h3>
                                                <p class="text-gray-600">Data cleaning, visualization, BI dashboards and actionable reports for growth.</p>
                                            </div>
                                            <div class="bg-purple-50 p-6 rounded-xl border border-purple-100">
                                                <h3 class="text-xl font-semibold text-gray-800 mb-3">Support & Training</h3>
                                                <p class="text-gray-600">Ongoing maintenance, analytics training and help to implement data-driven processes.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- About Section -->
                                    <div class="mb-12">
                                        <div class="grid md:grid-cols-2 gap-8 items-center">
                                            <div>
                                                <h2 class="text-2xl font-bold text-gray-800 mb-4">About WebCore Analytics</h2>
                                                <p class="text-gray-600 leading-relaxed mb-6">
                                                    Based in Shahdara, Delhi, WebCore Analytics is dedicated to helping small and medium businesses thrive online. We focus on practical solutions websites that convert and data insights that lead to better decisions. Our friendly, client-first approach means we build tools that you can actually use.
                                                </p>
                                                
                                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Why choose us?</h3>
                                                <ul class="space-y-2 text-gray-600">
                                                    <li class="flex items-start gap-2">
                                                        <span class="text-green-500 mt-1">✓</span>
                                                        <span>Clear communication we explain tech in plain language.</span>
                                                    </li>
                                                    <li class="flex items-start gap-2">
                                                        <span class="text-green-500 mt-1">✓</span>
                                                        <span>Affordable, scalable solutions for growing businesses.</span>
                                                    </li>
                                                    <li class="flex items-start gap-2">
                                                        <span class="text-green-500 mt-1">✓</span>
                                                        <span>Hands-on support and training so you get the most from your data.</span>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="bg-gradient-to-br from-blue-50 to-indigo-100 p-8 rounded-xl text-center">
                                                <div class="w-32 h-32 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-4xl font-bold">
                                                    WC
                                                </div>
                                                <h3 class="text-xl font-semibold text-gray-800 mb-2">WebCore Analytics</h3>
                                                <p class="text-gray-600">Building digital and data-driven futures</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Services Section -->
                                    <div class="mb-12">
                                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Our Services</h2>
                                        <div class="grid md:grid-cols-3 gap-6">
                                            <div class="bg-white border border-gray-200 p-6 rounded-xl hover:shadow-md transition-shadow">
                                                <h3 class="text-xl font-semibold text-gray-800 mb-3">Custom Websites</h3>
                                                <p class="text-gray-600">Fast, accessible, and mobile-first sites tailored to your brand.</p>
                                            </div>
                                            <div class="bg-white border border-gray-200 p-6 rounded-xl hover:shadow-md transition-shadow">
                                                <h3 class="text-xl font-semibold text-gray-800 mb-3">eCommerce</h3>
                                                <p class="text-gray-600">Secure stores with easy product management and checkout flows that convert.</p>
                                            </div>
                                            <div class="bg-white border border-gray-200 p-6 rounded-xl hover:shadow-md transition-shadow">
                                                <h3 class="text-xl font-semibold text-gray-800 mb-3">Data Dashboards</h3>
                                                <p class="text-gray-600">Interactive dashboards (Google Data Studio / Power BI / Looker) that show the metrics that matter.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Contact Section -->
                                    <div class="bg-gray-50 p-8 rounded-xl">
                                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Contact</h2>
                                        <p class="text-gray-600 mb-6">
                                            Have a question or want to start a project? Reach out anytime we'd love to hear from you.
                                        </p>
                                        
                                        <div class="space-y-4">
                                            <div class="flex items-center gap-3">
                                                <span class="text-2xl">📧</span>
                                                <a href="mailto:vinaykasaudhan083@gmail.com" class="text-blue-600 hover:text-blue-800 font-medium">
                                                    vinaykasaudhan083@gmail.com
                                                </a>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <span class="text-2xl">📍</span>
                                                <span class="text-gray-700">Shahdara, Delhi, India</span>
                                            </div>
                                        </div>
                                        
                                        <div class="flex gap-4 mt-6">
                                            <a href="https://www.linkedin.com/in/vinaykasaudhan" target="_blank" rel="noopener" 
                                               class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                                <span>🔗</span>
                                                <span>LinkedIn</span>
                                            </a>
                                            <a href="https://www.instagram.com/vinaykasaudhan1505/" target="_blank" rel="noopener"
                                               class="flex items-center gap-2 px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition-colors">
                                                <span>📸</span>
                                                <span>Instagram</span>
                                            </a>
                                        </div>
                                    </div>

                                    <!-- Footer -->
                                    <div class="mt-8 pt-6 border-t border-gray-200 text-center text-gray-500">
                                        <p>© <strong class="text-gray-700">WebCore Analytics</strong> Building digital and data-driven futures</p>
                                        <p class="mt-2">Made with care in Shahdara, Delhi • <a href="mailto:vinaykasaudhan083@gmail.com" class="text-blue-600 hover:text-blue-800">Contact</a></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // ========================================================================
                // --- 8. BILLING PAGE LOGIC ---
                // ========================================================================
        async function initializeBillingPage() {
            const content = document.getElementById('page-content');
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                                <div class="flex items-center gap-4">
                        <h2 class="text-xl font-bold text-gray-800">Recent Bills</h2>
                                    <div class="flex items-center gap-3">
                                        <div class="relative">
                                            <input type="text" id="patient-search" placeholder="Search by patient or doctor name..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                                </svg>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <label class="text-sm font-medium text-gray-700">Date Filter:</label>
                                            <input type="date" id="bill-date-filter" class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <button id="clear-date-filter" class="px-3 py-2 bg-gray-500 text-white text-sm rounded-md hover:bg-gray-600">Clear</button>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button id="download-doctor-pdf-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 hidden">
                                                📄 Download PDF
                                            </button>
                                        </div>
                                        <div id="unpaid-amount-card" class="bg-orange-50 border border-orange-200 rounded-lg px-4 py-2 hidden">
                                            <div class="flex items-center gap-2">
                                                <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                                                <span class="text-sm font-medium text-orange-800">Unpaid Amount:</span>
                                                <span id="unpaid-total" class="text-sm font-bold text-orange-900">₹0.00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        <button id="add-bill-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 shadow">Create New Bill</button>
                    </div>
                    <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                                <th class="px-6 py-3 text-left">Bill #</th><th class="px-6 py-3 text-left">Patient</th><th class="px-6 py-3 text-left">Ref Doc</th><th class="px-6 py-3 text-left">Date</th><th class="px-6 py-3 text-left">Total</th><th class="px-6 py-3 text-left">Commission</th><th class="px-6 py-3 text-left">Status</th><th class="px-6 py-3 text-left">Left Amount</th><th class="px-6 py-3 text-left">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bills-list-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="bill-modal" class="fixed inset-0 modal-bg hidden flex items-center justify-center p-4">
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-4xl modal-content transform scale-95 overflow-y-auto">
                        <h3 id="modal-title" class="text-2xl mb-4 font-bold text-gray-800">Create Bill</h3>
                        <form id="bill-form"><!-- Form content is injected here --></form>
                    </div>
                </div>
            `;
            
            document.getElementById('bill-form').innerHTML = `
                        <fieldset class="border p-4 rounded-md mb-4"><legend class="px-2 font-semibold">Patient Details</legend><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm">Patient Name*</label><input type="text" id="patient-name" class="w-full p-2 border rounded-md" required></div><div><label class="block text-sm">Phone</label><input type="tel" id="patient-phone" class="w-full p-2 border rounded-md"></div><div><label class="block text-sm">Age*</label><input type="number" id="patient-age" class="w-full p-2 border rounded-md" required min="0"></div><div><label class="block text-sm">Gender*</label><select id="patient-gender" class="w-full p-2 border rounded-md" required><option value="" disabled selected>Select gender</option><option>Male</option><option>Female</option><option>Other</option></select></div><div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4"><div id="referred-by-container"><select id="referred-by" class="w-full p-2 border rounded-md"><option value="">None</option></select></div><div><label class="block text-sm">Payment Method*</label><select id="payment-method" class="w-full p-2 border rounded-md" required><option value="" disabled selected>Select payment method</option><option value="cash">Cash</option><option value="upi">UPI</option><option value="both">Both</option></select></div></div><div id="both-payment-fields" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 hidden"><div><label class="block text-sm">Cash Amount (₹)*</label><input type="number" id="cash-amount" class="w-full p-2 border rounded-md" min="0" step="0.01" placeholder="0.00"></div><div><label class="block text-sm">UPI Amount (₹)*</label><input type="number" id="upi-amount" class="w-full p-2 border rounded-md" min="0" step="0.01" placeholder="0.00"></div></div><div id="other-doctor-fields" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 hidden"><div><label class="block text-sm">Doctor Name*</label><input type="text" id="other-doctor-name" class="w-full p-2 border rounded-md" placeholder="Enter doctor name"></div><div><label class="block text-sm">Commission %</label><input type="number" id="other-doctor-commission" class="w-full p-2 border rounded-md" min="0" max="100" step="0.01" placeholder="0" value="0"></div></div></div></fieldset>
                <fieldset class="border p-4 rounded-md mb-4"><legend class="px-2 font-semibold">Bill Items</legend><div id="bill-items" class="space-y-3 mb-3"></div><button type="button" id="add-item-btn" class="px-3 py-1 bg-green-500 text-white text-sm rounded-md hover:bg-green-600">Add Test</button></fieldset>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4"><div class="space-y-2"><div><label class="block text-sm">Discount (₹)</label><input type="number" id="discount-amount" value="0" min="0" step="0.01" class="w-full p-2 border rounded-md"></div><div><label class="block text-sm">GST (%)</label><input type="number" id="gst-percent" value="0" min="0" class="w-full p-2 border rounded-md"></div></div><div class="text-right space-y-1 text-gray-700"><p>Subtotal: <span id="subtotal" class="font-medium text-black">₹0.00</span></p><p>Discount: <span id="discount-display" class="font-medium text-black">₹0.00</span></p><p class="border-t pt-1 mt-1">Total after Discount: <span id="post-discount-total" class="font-medium text-black">₹0.00</span></p><p>GST: <span id="gst-amount" class="font-medium text-black">₹0.00</span></p><p class="font-bold text-xl border-t pt-1 mt-1">Grand Total: <span id="grand-total" class="text-blue-600">₹0.00</span></p></div></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button" id="close-modal-btn" class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400 font-semibold">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold">Save Bill</button></div>
            `;
            
            let allTests = [], allDoctors = [];
            const billModal = document.getElementById('bill-modal');
            const billForm = document.getElementById('bill-form');
            const billItemsContainer = document.getElementById('bill-items');
            
            const openModal = () => {
                billModal.classList.remove('hidden');
                setTimeout(() => billModal.querySelector('.modal-content').classList.remove('scale-95'), 10);
            };
            const closeModalBilling = () => {
                billModal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => {
                    billModal.classList.add('hidden');
                    billForm.reset();
                    billItemsContainer.innerHTML = '';
                    updateBillTotals();
                }, 300);
            }

            function updateBillTotals() {
                let subtotal = 0;
                billItemsContainer.querySelectorAll('.bill-item').forEach(itemRow => {
                    subtotal += parseFloat(itemRow.dataset.price || 0) * parseInt(itemRow.querySelector('.item-quantity').value || 1);
                });
                        const discountAmount = parseFloat(document.getElementById('discount-amount').value) || 0;
                const gstPercent = parseFloat(document.getElementById('gst-percent').value) || 0;
                        const postDiscountTotal = Math.max(0, subtotal - discountAmount);
                const gstAmount = postDiscountTotal * (gstPercent / 100);
                const grandTotal = postDiscountTotal + gstAmount;
                document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
                        document.getElementById('discount-display').textContent = `- ₹${discountAmount.toFixed(2)}`;
                document.getElementById('post-discount-total').textContent = `₹${postDiscountTotal.toFixed(2)}`;
                document.getElementById('gst-amount').textContent = `+ ₹${gstAmount.toFixed(2)}`;
                document.getElementById('grand-total').textContent = `₹${grandTotal.toFixed(2)}`;
            }

            function addBillItem() {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bill-item flex items-center gap-2';
                itemDiv.dataset.price = "0";
                        
                        // Create searchable test dropdown
                        const testDropdownId = `test-dropdown-${Date.now()}`;
                        itemDiv.innerHTML = `
                            <div class="relative flex-grow">
                                <input type="text" class="test-search-input w-full p-2 border rounded-md" placeholder="Search tests..." autocomplete="off">
                                <div class="test-dropdown absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto">
                                    ${allTests.map(t => `<div class="test-option px-3 py-2 hover:bg-gray-100 cursor-pointer" data-id="${t.id}" data-price="${t.price}">${t.name} (₹${t.price})</div>`).join('')}
                                </div>
                                <input type="hidden" class="item-test-select" value="">
                            </div>
                            <input type="number" value="1" min="1" class="item-quantity w-16 p-2 border rounded-md">
                            <button type="button" class="remove-item-btn p-2 bg-red-500 text-white rounded-md leading-none">X</button>
                        `;
                billItemsContainer.appendChild(itemDiv);
                
                        // Add search functionality for test dropdown
                        const searchInput = itemDiv.querySelector('.test-search-input');
                        const dropdown = itemDiv.querySelector('.test-dropdown');
                        const hiddenInput = itemDiv.querySelector('.item-test-select');
                        
                        searchInput.addEventListener('input', (e) => {
                            const searchTerm = e.target.value.toLowerCase();
                            const options = dropdown.querySelectorAll('.test-option');
                            
                            options.forEach(option => {
                                const text = option.textContent.toLowerCase();
                                if (text.includes(searchTerm)) {
                                    option.style.display = 'block';
                                } else {
                                    option.style.display = 'none';
                                }
                            });
                            
                            dropdown.classList.remove('hidden');
                        });
                        
                        searchInput.addEventListener('focus', () => {
                            dropdown.classList.remove('hidden');
                        });
                        
                        searchInput.addEventListener('blur', () => {
                            setTimeout(() => dropdown.classList.add('hidden'), 200);
                        });
                        
                        dropdown.addEventListener('click', (e) => {
                            if (e.target.classList.contains('test-option')) {
                                const testId = e.target.dataset.id;
                                const testPrice = e.target.dataset.price;
                                const testName = e.target.textContent.split(' (₹')[0];
                                
                                searchInput.value = testName;
                                hiddenInput.value = testId;
                                itemDiv.dataset.price = testPrice;
                                dropdown.classList.add('hidden');
                    updateBillTotals();
                            }
                        });
                        
                        
                itemDiv.querySelector('.item-quantity').oninput = updateBillTotals;
                itemDiv.querySelector('.remove-item-btn').onclick = () => { itemDiv.remove(); updateBillTotals(); };
                updateBillTotals();
            }

            async function loadPrerequisites() {
                const [testsSnap, doctorsSnap] = await Promise.all([db.collection('tests').get(), db.collection('doctors').get()]);
                allTests = testsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allDoctors = doctorsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // Create searchable doctor dropdown
                        const referredByContainer = document.getElementById('referred-by-container');
                        if (referredByContainer) {
                            // Clear any existing content to prevent duplication
                            referredByContainer.innerHTML = '';
                            
                            referredByContainer.innerHTML = `
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Doctor</label>
                                <label class="block text-sm">Referred By</label>
                                <div class="relative">
                                    <input type="text" id="doctor-search-input" class="w-full p-2 border rounded-md" placeholder="Search doctors..." autocomplete="off">
                                    <div id="doctor-dropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto">
                                        <div class="doctor-option px-3 py-2 hover:bg-gray-100 cursor-pointer" data-id="">Self</div>
                                        ${allDoctors.map(d => `<div class="doctor-option px-3 py-2 hover:bg-gray-100 cursor-pointer" data-id="${d.id}">${d.name}</div>`).join('')}
                                        <div class="doctor-option px-3 py-2 hover:bg-gray-100 cursor-pointer border-t" data-id="other">Other</div>
                                    </div>
                                    <input type="hidden" id="referred-by" value="">
                                </div>
                            `;
                        }
                        
                        // Add search functionality for doctor dropdown
                        const doctorSearchInput = document.getElementById('doctor-search-input');
                        const doctorDropdown = document.getElementById('doctor-dropdown');
                        const doctorHiddenInput = document.getElementById('referred-by');
                        
                        // Only add event listeners if elements exist and haven't been set up already
                        if (doctorSearchInput && !doctorSearchInput.hasAttribute('data-listener-added')) {
                        
                        doctorSearchInput.addEventListener('input', (e) => {
                            const searchTerm = e.target.value.toLowerCase();
                            const options = doctorDropdown.querySelectorAll('.doctor-option');
                            
                            options.forEach(option => {
                                const text = option.textContent.toLowerCase();
                                if (text.includes(searchTerm)) {
                                    option.style.display = 'block';
                                } else {
                                    option.style.display = 'none';
                                }
                            });
                            
                            doctorDropdown.classList.remove('hidden');
                        });
                        
                        doctorSearchInput.addEventListener('focus', () => {
                            doctorDropdown.classList.remove('hidden');
                        });
                        
                        doctorSearchInput.addEventListener('blur', () => {
                            setTimeout(() => doctorDropdown.classList.add('hidden'), 200);
                        });
                        
                        doctorDropdown.addEventListener('click', (e) => {
                            if (e.target.classList.contains('doctor-option')) {
                                const doctorId = e.target.dataset.id;
                                const doctorName = e.target.textContent;
                                
                                doctorSearchInput.value = doctorName;
                                doctorHiddenInput.value = doctorId;
                                doctorDropdown.classList.add('hidden');
                                
                                // Show/hide other doctor fields
                                const otherFields = document.getElementById('other-doctor-fields');
                                if (doctorId === 'other') {
                                    otherFields.classList.remove('hidden');
                                    document.getElementById('other-doctor-name').required = true;
                                } else {
                                    otherFields.classList.add('hidden');
                                    document.getElementById('other-doctor-name').required = false;
                                    document.getElementById('other-doctor-name').value = '';
                                    document.getElementById('other-doctor-commission').value = '0';
                                }
                            }
                        });
                        
                            // Mark as having listeners to prevent duplication
                            doctorSearchInput.setAttribute('data-listener-added', 'true');
                        }
            }
            
            document.getElementById('add-bill-btn').onclick = () => { loadPrerequisites().then(() => { openModal(); }); };
            document.getElementById('close-modal-btn').onclick = closeModalBilling;
            document.getElementById('add-item-btn').onclick = addBillItem;
                    ['discount-amount', 'gst-percent'].forEach(id => { document.getElementById(id).oninput = updateBillTotals; });
                    
                    // Handle payment method change
                    document.getElementById('payment-method').onchange = function() {
                        const bothFields = document.getElementById('both-payment-fields');
                        const cashAmount = document.getElementById('cash-amount');
                        const upiAmount = document.getElementById('upi-amount');
                        
                        if (this.value === 'both') {
                            bothFields.classList.remove('hidden');
                            cashAmount.required = true;
                            upiAmount.required = true;
                        } else {
                            bothFields.classList.add('hidden');
                            cashAmount.required = false;
                            upiAmount.required = false;
                            cashAmount.value = '';
                            upiAmount.value = '';
                        }
                    };
                    
                    // Add validation for both payment amounts
                    ['cash-amount', 'upi-amount'].forEach(id => {
                        document.getElementById(id).oninput = function() {
                            const cashAmount = parseFloat(document.getElementById('cash-amount').value) || 0;
                            const upiAmount = parseFloat(document.getElementById('upi-amount').value) || 0;
                            const grandTotal = parseFloat(document.getElementById('grand-total').textContent.replace('₹', '').replace(',', '')) || 0;
                            const total = cashAmount + upiAmount;
                            
                            // Update validation message
                            let validationMsg = document.getElementById('payment-validation-msg');
                            if (!validationMsg) {
                                validationMsg = document.createElement('div');
                                validationMsg.id = 'payment-validation-msg';
                                validationMsg.className = 'text-sm mt-2';
                                document.getElementById('both-payment-fields').appendChild(validationMsg);
                            }
                            
                            if (Math.abs(total - grandTotal) < 0.01) {
                                validationMsg.textContent = '✓ Amounts match total';
                                validationMsg.className = 'text-sm mt-2 text-green-600';
                            } else {
                                validationMsg.textContent = `⚠ Total: ₹${total.toFixed(2)}, Required: ₹${grandTotal.toFixed(2)}`;
                                validationMsg.className = 'text-sm mt-2 text-red-600';
                            }
                        };
                    });
                    
                    // Enable fast keyboard navigation within the billing form
                    (function enableFormKeyboardNav(formEl) {
                        const focusableSelector = 'input:not([type=hidden]):not([disabled]), select:not([disabled]), button:not([disabled])';
                        function getFocusable() {
                            return Array.from(formEl.querySelectorAll(focusableSelector)).filter(el => el.offsetParent !== null);
                        }
                        formEl.addEventListener('keydown', (ev) => {
                            const focusables = getFocusable();
                            const currentIndex = focusables.indexOf(document.activeElement);
                            if (currentIndex === -1) return;

                            const isTextInput = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT' || document.activeElement.tagName === 'TEXTAREA';

                            const go = (offset) => {
                                const nextIndex = Math.max(0, Math.min(focusables.length - 1, currentIndex + offset));
                                const target = focusables[nextIndex];
                                if (target) { ev.preventDefault(); target.focus(); if (target.select) { target.select(); } }
                            };

                            // Enter advances, Shift+Enter goes back
                            if (ev.key === 'Enter') {
                                // If on submit button, allow submit default
                                if (document.activeElement.type === 'submit') return;
                                go(ev.shiftKey ? -1 : 1);
                            }
                            // Up/Down arrows navigate
                            if (ev.key === 'ArrowDown') { go(1); }
                            if (ev.key === 'ArrowUp') { go(-1); }
                            // Backspace on empty field moves back
                            if (ev.key === 'Backspace' && isTextInput) {
                                const val = (document.activeElement.value || '').toString();
                                if (val.length === 0) { go(-1); }
                            }
                        });
                    })(billForm);

                    // Note: "Other" doctor selection is now handled in the searchable dropdown above
            
            billForm.onsubmit = async (e) => {
                e.preventDefault();
                const submitBtn = billForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';

                try {
                    const patientPhone = document.getElementById('patient-phone').value.trim();
                    const ageValue = parseInt(document.getElementById('patient-age').value);
                    const genderValue = document.getElementById('patient-gender').value;
                    if (!Number.isFinite(ageValue) || ageValue <= 0) { throw new Error('Age is required and must be greater than 0'); }
                    if (!genderValue) { throw new Error('Gender is required'); }
                    let patientId;
                    const patientDetails = { name: document.getElementById('patient-name').value, age: ageValue, gender: genderValue, phone: patientPhone || null };
                    let patientQuery = patientPhone ? await db.collection('patients').where('phone', '==', patientPhone).limit(1).get() : null;
                    if (patientQuery && !patientQuery.empty) {
                        patientId = patientQuery.docs[0].id;
                        await db.collection('patients').doc(patientId).update(patientDetails);
                    } else {
                                patientDetails.createdAt = Timestamp.now();
                        patientId = (await db.collection('patients').add(patientDetails)).id;
                    }

                    const items = Array.from(billItemsContainer.querySelectorAll('.bill-item'))
                        .map(row => {
                            const testId = row.querySelector('.item-test-select').value;
                            const test = allTests.find(t => t.id === testId);
                            if (!test) return null;
                            return { testId, name: test.name, price: test.price, quantity: parseInt(row.querySelector('.item-quantity').value) || 1 };
                        })
                        .filter(item => item !== null);

                    if (items.length === 0) throw new Error("At least one valid test must be added.");

                    const subtotal = items.reduce((acc, item) => acc + (item.price * item.quantity), 0);
                            const discountAmount = parseFloat(document.getElementById('discount-amount').value) || 0;
                    const gstPercent = parseFloat(document.getElementById('gst-percent').value) || 0;
                            const postDiscountTotal = Math.max(0, subtotal - discountAmount);
                            const total = postDiscountTotal * (1 + gstPercent / 100);

                    // Allocate next bill number from meta/billing (prefix PD)
                    const billingRef = db.collection('meta').doc('billing');
                    const newBillNumber = await db.runTransaction(async (tx) => {
                        const snap = await tx.get(billingRef);
                        if (!snap.exists) throw new Error('Bill counter not found! Please create meta/billing with nextNumber.');
                        const data = snap.data() || {};
                        const currentNumber = typeof data.nextNumber === 'number' ? data.nextNumber : 20010000;
                        tx.update(billingRef, { nextNumber: currentNumber + 1, lastUpdated: Timestamp.now() });
                        return `PD${currentNumber}`;
                    });
                    
                            const referredById = document.getElementById('referred-by').value;
                            let doctorName = '';
                            let doctorCommissionPercent = 0;
                            let newDoctorId = null;

                            if (referredById === 'other') {
                                // Handle "Other" doctor case
                                doctorName = document.getElementById('other-doctor-name').value;
                                doctorCommissionPercent = parseFloat(document.getElementById('other-doctor-commission').value) || 0;
                                
                                if (!doctorName.trim()) {
                                    throw new Error("Please enter doctor name for 'Other' option.");
                                }
                                
                                // Add doctor to database only if commission > 0
                                if (doctorCommissionPercent > 0) {
                                    const newDoctorData = {
                                        name: doctorName,
                                        commissionPercent: doctorCommissionPercent,
                                        commissionBalance: 0,
                                        location: 'External',
                                        createdAt: Timestamp.now()
                                    };
                                    const newDoctorRef = await db.collection('doctors').add(newDoctorData);
                                    newDoctorId = newDoctorRef.id;
                                }
                            } else if (referredById) {
                                // Handle existing doctor
                                const doctor = allDoctors.find(d => d.id === referredById);
                                if (doctor) {
                                    doctorName = doctor.name;
                                    doctorCommissionPercent = doctor.commissionPercent;
                                }
                            }

                            // Create bill data
                            const paymentMethod = document.getElementById('payment-method').value;
                            const billData = { 
                                patientId, 
                                patientDetails, 
                                billNumber: newBillNumber, 
                                referredById: newDoctorId || referredById || null, 
                                referredByName: doctorName || null,
                                items, 
                                subtotal, 
                                discountAmount, 
                                gstPercent, 
                                total, 
                                paymentMethod: paymentMethod,
                                createdAt: Timestamp.now() 
                            };
                            
                            // Add payment amounts for "both" method
                            if (paymentMethod === 'both') {
                                const cashAmount = parseFloat(document.getElementById('cash-amount').value) || 0;
                                const upiAmount = parseFloat(document.getElementById('upi-amount').value) || 0;
                                
                                // Validate amounts match total
                                if (Math.abs((cashAmount + upiAmount) - total) > 0.01) {
                                    throw new Error('Cash and UPI amounts must equal the total amount');
                                }
                                
                                billData.cashAmount = cashAmount;
                                billData.upiAmount = upiAmount;
                            }
                    const billRef = await db.collection('bills').add(billData);

                    await db.collection('transactions').add({ type: 'income', amount: total, description: `Payment for Bill #${newBillNumber}`, relatedBillId: billRef.id, date: Timestamp.now() });

                            // Process commission if doctor has commission > 0
                            if (doctorCommissionPercent > 0) {
                                const commissionAmount = subtotal * (doctorCommissionPercent / 100);
                                
                                // If there's a discount, deduct it from doctor's commission
                                let finalCommissionAmount = commissionAmount;
                                if (discountAmount > 0) {
                                    finalCommissionAmount = Math.max(0, commissionAmount - discountAmount);
                                    
                                    // Record discount deduction from doctor commission
                                    if (discountAmount > commissionAmount) {
                                        // If discount is more than commission, doctor gets 0 commission
                                        await db.collection('transactions').add({ 
                                            type: 'commission_discount', 
                                            amount: -commissionAmount, 
                                            description: `Discount of ₹${discountAmount.toFixed(2)} deducted from Dr. ${doctorName}'s commission (₹${commissionAmount.toFixed(2)}) for Bill #${newBillNumber}`, 
                                            relatedBillId: billRef.id, 
                                            relatedDoctorId: newDoctorId || referredById, 
                                            date: Timestamp.now() 
                                        });
                                    } else {
                                        // Partial deduction from commission
                                        await db.collection('transactions').add({ 
                                            type: 'commission_discount', 
                                            amount: -discountAmount, 
                                            description: `Discount of ₹${discountAmount.toFixed(2)} deducted from Dr. ${doctorName}'s commission for Bill #${newBillNumber}`, 
                                            relatedBillId: billRef.id, 
                                            relatedDoctorId: newDoctorId || referredById, 
                                            date: Timestamp.now() 
                                        });
                                    }
                                }
                                
                                // Update doctor's commission balance with final amount
                                const doctorId = newDoctorId || referredById;
                                await db.collection('doctors').doc(doctorId).update({ commissionBalance: FieldValue.increment(finalCommissionAmount) });
                                await db.collection('transactions').add({ 
                                    type: 'commission', 
                                    amount: finalCommissionAmount, 
                                    description: `Commission for Bill #${newBillNumber} to Dr. ${doctorName} (after discount deduction)`, 
                                    relatedBillId: billRef.id, 
                                    relatedDoctorId: doctorId, 
                                    date: Timestamp.now() 
                                });
                            } else if (referredById === 'other' || !referredById) {
                                // Self-referred or other doctor with 0% commission: Record discount as owner's loss
                                if (discountAmount > 0) {
                                    await db.collection('transactions').add({ 
                                        type: 'owner_discount', 
                                        amount: -discountAmount, 
                                        description: `Self-referred discount of ₹${discountAmount.toFixed(2)} for Bill #${newBillNumber}`, 
                                        relatedBillId: billRef.id, 
                                        date: Timestamp.now() 
                                    });
                        }
                    }
                    
                    closeModalBilling();
                    showBillSuccessModal(billRef.id, newBillNumber);

                } catch (error) {
                    console.error("Error creating bill: ", error);
                    showModal('Creation Failed', "Failed to create bill: " + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Bill';
                }
            };
            
            const billsListBody = document.getElementById('bills-list-body');
            
            // Event Delegation for action buttons
            billsListBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-pdf-btn')) {
                    const billId = e.target.dataset.id;
                    if (billId) {
                        generateAndDownloadPDF(billId, 'download');
                    }
                }
                if (e.target.classList.contains('refund-bill-btn')) {
                    const billId = e.target.dataset.id;
                    if (billId) {
                        handleRefundBill(billId);
                    }
                }
            });

                    let allBills = [];
                    let filteredBills = [];

                    function renderBills(bills) {
                billsListBody.innerHTML = '';
                        if (bills.length === 0) {
                            billsListBody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-gray-500">No bills found. Create one to get started!</td></tr>`; 
                            return;
                }
                        bills.forEach(bill => {
                    const patientName = bill.patientDetails?.name || 'Unknown';
                    const row = billsListBody.insertRow();
                    const status = bill.status === 'refunded' ? 'refunded' : 'paid';
                            const leftAmount = bill.leftAmount || 0;
                            
                            // Get referred doctor name and get stored commission amount
                            let refDocName = 'Self';
                            let commissionAmount = 0;
                            
                            if (bill.referredByName) {
                                refDocName = bill.referredByName;
                            } else if (bill.referredById) {
                                const doctor = allDoctors.find(d => d.id === bill.referredById);
                                if (doctor) {
                                    refDocName = doctor.name;
                                } else {
                                    console.log('Doctor not found in allDoctors array:', {
                                        referredById: bill.referredById,
                                        allDoctorsCount: allDoctors.length,
                                        allDoctorsIds: allDoctors.map(d => d.id)
                                    });
                                    refDocName = 'Unknown Doctor';
                                }
                            }
                            
                            // Get stored commission amount from transactions
                            commissionAmount = window.commissionMap.get(bill.id) || 0;
                            
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900">${bill.billNumber}</td>
                        <td class="px-6 py-4 text-gray-700">${patientName}</td>
                                <td class="px-6 py-4 text-gray-600">${refDocName}</td>
                        <td class="px-6 py-4 text-gray-600">${bill.createdAt.toDate().toLocaleDateString()}</td>
                        <td class="px-6 py-4 font-semibold text-gray-900">₹${bill.total.toFixed(2)}</td>
                        <td class="px-6 py-4 font-semibold text-orange-600">₹${commissionAmount.toFixed(2)}</td>
                        <td class="px-6 py-4">
                            <span class="inline-block px-2 py-1 rounded text-xs font-semibold ${status === 'refunded' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${status}</span>
                        </td>
                                <td class="px-6 py-4">
                                    ${leftAmount > 0 ? `
                                        <div class="text-center">
                                            <div class="text-sm font-semibold text-orange-600 mb-1">₹${leftAmount.toFixed(2)}</div>
                                            <button data-id="${bill.id}" class="mark-paid-btn px-2 py-1 bg-orange-500 text-white text-xs rounded hover:bg-orange-600">Mark Paid</button>
                                        </div>
                                    ` : `
                                        <div class="flex items-center gap-2">
                                            <input type="number" id="left-amount-${bill.id}" value="0" min="0" step="0.01" placeholder="0" class="w-20 px-2 py-1 border rounded text-sm">
                                            <button data-id="${bill.id}" class="add-left-amount-btn px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600">Add</button>
                                        </div>
                                    `}
                                </td>
                        <td class="px-6 py-4 flex gap-3">
                                    <button data-id="${bill.id}" class="view-pdf-btn text-blue-600 hover:underline font-semibold">View/PDF</button>
                                    ${status !== 'refunded' ? `<button data-id="${bill.id}" class="refund-bill-btn text-red-600 hover:underline font-semibold">Refund</button>` : ''}
                        </td>
                    `;
                });
                    }

                    // Load doctors first, then set up bills listener
                    async function initializeBillingData() {
                        const doctorsSnap = await db.collection('doctors').get();
                        allDoctors = doctorsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // Load commission transactions
                        const commissionTransactionsSnap = await db.collection('transactions')
                            .where('type', '==', 'commission')
                            .get();
                        
                        // Create a map of billId -> commission amount
                        window.commissionMap = new Map();
                        commissionTransactionsSnap.forEach(doc => {
                            const transaction = doc.data();
                            if (transaction.relatedBillId) {
                                window.commissionMap.set(transaction.relatedBillId, transaction.amount);
                            }
                        });
                        
                        console.log('Commission Map:', window.commissionMap);
                        
                        const unsubscribe = db.collection('bills').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                            allBills = [];
                            snapshot.forEach(doc => {
                                allBills.push({ id: doc.id, ...doc.data() });
                            });
                            filteredBills = allBills;
                            renderBills(filteredBills);
            });
            state.listeners.push(unsubscribe);
                    }
                    
                    initializeBillingData();

                    // Search and filter functionality
                    function applyFilters() {
                        const searchTerm = document.getElementById('patient-search').value.toLowerCase();
                        const dateFilter = document.getElementById('bill-date-filter').value;
                        const pdfButton = document.getElementById('download-doctor-pdf-btn');
                        
                        filteredBills = allBills.filter(bill => {
                            // Patient name filter
                            const patientName = (bill.patientDetails?.name || 'Unknown').toLowerCase();
                            
                            // Doctor name filter
                            let doctorName = '';
                            if (bill.referredByName) {
                                doctorName = bill.referredByName.toLowerCase();
                            } else if (bill.referredById) {
                                const doctor = allDoctors.find(d => d.id === bill.referredById);
                                if (doctor) {
                                    doctorName = doctor.name.toLowerCase();
                                }
                            } else {
                                // Self-referred case - no referredById and no referredByName
                                doctorName = 'self';
                            }
                            
                            // Search in both patient name and doctor name
                            const matchesSearch = patientName.includes(searchTerm) || doctorName.includes(searchTerm);
                            
                            // Date filter
                            let matchesDate = true;
                            if (dateFilter) {
                                const billDate = bill.createdAt.toDate().toISOString().split('T')[0];
                                matchesDate = billDate === dateFilter;
                            }
                            
                            return matchesSearch && matchesDate;
                        });
                        
                        // Check if search is for a specific doctor (not patient name)
                        const isDoctorSearch = searchTerm && !searchTerm.includes('self') && 
                            filteredBills.some(bill => {
                                if (bill.referredByName) {
                                    return bill.referredByName.toLowerCase().includes(searchTerm);
                                } else if (bill.referredById) {
                                    const doctor = allDoctors.find(d => d.id === bill.referredById);
                                    return doctor && doctor.name.toLowerCase().includes(searchTerm);
                                }
                                return false;
                            });
                        
                        // Show/hide PDF button based on doctor search
                        if (isDoctorSearch && filteredBills.length > 0) {
                            pdfButton.classList.remove('hidden');
                        } else {
                            pdfButton.classList.add('hidden');
                        }
                        
                        renderBills(filteredBills);
                        
                        // Update unpaid amount card
                        updateUnpaidAmountCard(dateFilter);
                    }
                    
                    // Function to calculate and display unpaid amount for selected date
                    function updateUnpaidAmountCard(selectedDate) {
                        const unpaidCard = document.getElementById('unpaid-amount-card');
                        const unpaidTotal = document.getElementById('unpaid-total');
                        
                        if (!selectedDate) {
                            unpaidCard.classList.add('hidden');
                            return;
                        }
                        
                        // Calculate unpaid amount for the selected date
                        const unpaidAmount = allBills
                            .filter(bill => {
                                const billDate = bill.createdAt.toDate().toISOString().split('T')[0];
                                return billDate === selectedDate && (bill.leftAmount || 0) > 0;
                            })
                            .reduce((total, bill) => total + (bill.leftAmount || 0), 0);
                        
                        if (unpaidAmount > 0) {
                            unpaidTotal.textContent = `₹${unpaidAmount.toFixed(2)}`;
                            unpaidCard.classList.remove('hidden');
                        } else {
                            unpaidCard.classList.add('hidden');
                        }
                    }

                    // Event listeners
                    document.getElementById('patient-search').addEventListener('input', applyFilters);
                    document.getElementById('bill-date-filter').addEventListener('change', applyFilters);
                    document.getElementById('clear-date-filter').addEventListener('click', () => {
                        document.getElementById('bill-date-filter').value = '';
                        applyFilters();
                    });
                    
                    // PDF download button event listener
                    document.getElementById('download-doctor-pdf-btn').addEventListener('click', () => {
                        const searchTerm = document.getElementById('patient-search').value.toLowerCase();
                        
                        // Find the doctor name from the search term
                        let doctorName = '';
                        const doctorBills = filteredBills.filter(bill => {
                            if (bill.referredByName) {
                                if (bill.referredByName.toLowerCase().includes(searchTerm)) {
                                    if (!doctorName) doctorName = bill.referredByName;
                                    return true;
                                }
                            } else if (bill.referredById) {
                                const doctor = allDoctors.find(d => d.id === bill.referredById);
                                if (doctor && doctor.name.toLowerCase().includes(searchTerm)) {
                                    if (!doctorName) doctorName = doctor.name;
                                    return true;
                                }
                            }
                            return false;
                        });
                        
                        if (doctorBills.length > 0) {
                            generateDoctorCommissionPDF(doctorName, doctorBills, allDoctors);
                        } else {
                            showModal('No Data', 'No bills found for the selected doctor.');
                        }
                    });

                    // Event delegation for Left Amount buttons
                    billsListBody.addEventListener('click', (e) => {
                        if (e.target.classList.contains('add-left-amount-btn')) {
                            const billId = e.target.dataset.id;
                            const input = document.getElementById(`left-amount-${billId}`);
                            const amount = parseFloat(input.value) || 0;
                            
                            if (amount > 0) {
                                addLeftAmount(billId, amount);
                            } else {
                                showModal('Invalid Amount', 'Please enter a valid amount greater than 0.');
                            }
                        }
                        
                        if (e.target.classList.contains('mark-paid-btn')) {
                            const billId = e.target.dataset.id;
                            markLeftAmountAsPaid(billId);
                        }
                    });

                    async function addLeftAmount(billId, amount) {
                        try {
                            await db.collection('bills').doc(billId).update({
                                leftAmount: amount,
                                lastUpdated: Timestamp.now()
                            });
                            
                            // Update local data
                            const bill = allBills.find(b => b.id === billId);
                            if (bill) {
                                bill.leftAmount = amount;
                            }
                            
                            showModal('Success', `Left amount of ₹${amount.toFixed(2)} added successfully!`);
                            
                            // Update unpaid amount card
                            const dateFilter = document.getElementById('bill-date-filter').value;
                            updateUnpaidAmountCard(dateFilter);
                        } catch (error) {
                            console.error('Error adding left amount:', error);
                            showModal('Error', 'Failed to add left amount. Please try again.');
                        }
                    }

                    async function markLeftAmountAsPaid(billId) {
                        try {
                            await db.collection('bills').doc(billId).update({
                                leftAmount: 0,
                                lastUpdated: Timestamp.now()
                            });
                            
                            // Update local data
                            const bill = allBills.find(b => b.id === billId);
                            if (bill) {
                                bill.leftAmount = 0;
                            }
                            
                            showModal('Success', 'Left amount marked as paid successfully!');
                            
                            // Update unpaid amount card
                            const dateFilter = document.getElementById('bill-date-filter').value;
                            updateUnpaidAmountCard(dateFilter);
                        } catch (error) {
                            console.error('Error marking as paid:', error);
                            showModal('Error', 'Failed to mark as paid. Please try again.');
                        }
                    }
        }

        async function handleRefundBill(billId) {
            showConfirmationModal('Refund Bill', 'Are you sure you want to refund this bill? This will reverse revenue and commission.', async () => {
                try {
                    const now = Timestamp.now();
                    const billRef = db.collection('bills').doc(billId);
                    const billSnap = await billRef.get();
                    if (!billSnap.exists) { showModal('Not Found', 'Bill not found.'); return; }
                    const bill = billSnap.data();
                    if (bill.status === 'refunded') { showModal('Already Refunded', 'This bill has already been refunded.'); return; }

                    // Mark bill as refunded
                    await billRef.update({ status: 'refunded', refundedAt: now });

                    // Reverse income
                    await db.collection('transactions').add({ type: 'income', amount: -Number(bill.total || 0), description: `Refund for Bill #${bill.billNumber}`, relatedBillId: billId, date: now });

                    // Reverse commission if applicable
                    if (bill.referredById) {
                        const doctorRef = db.collection('doctors').doc(bill.referredById);
                        const doctorSnap = await doctorRef.get();
                        const percent = doctorSnap.exists ? (doctorSnap.data().commissionPercent || 0) : 0;
                        if (percent > 0) {
                            const commissionAmount = Number(bill.subtotal || 0) * (percent / 100);
                            await doctorRef.update({ commissionBalance: FieldValue.increment(-commissionAmount) });
                            await db.collection('transactions').add({ type: 'commission', amount: -commissionAmount, description: `Commission reversal for Bill #${bill.billNumber}`, relatedBillId: billId, relatedDoctorId: bill.referredById, date: now });
                        }
                    }

                    showModal('Refunded', 'Bill has been refunded successfully.');
                } catch (error) {
                    console.error('Refund error:', error);
                    showModal('Error', 'Failed to refund bill. Please try again.');
                }
            });
        }
        
        // ========================================================================
        // --- 9. DASHBOARD & REPORTS ---
        // ========================================================================
        
        async function renderDashboard() {
            const content = document.getElementById('page-content');
            content.innerHTML = `<div id="dashboard-loader" class="text-center py-10"><div class="spinner h-12 w-12 mx-auto border-4"></div></div><div id="dashboard-content" class="hidden"></div>`;

            try {
                // Fetch today's data
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const startOfDay = Timestamp.fromDate(today);

                const [patientsSnap, transactionsSnap, expendituresSnap] = await Promise.all([
                    db.collection('patients').where('createdAt', '>=', startOfDay).get(),
                    db.collection('transactions').where('date', '>=', startOfDay).get(),
                    db.collection('expenditures').where('date', '>=', startOfDay).get()
                ]);

                const dailyPatients = patientsSnap.size;
                        let dailyIncomeTotal = 0, dailyCommission = 0, dailyExpenditureTotal = 0, dailyDiscountTotal = 0;

                transactionsSnap.forEach(doc => {
                    const t = doc.data();
                    if (t.type === 'income') dailyIncomeTotal += t.amount;
                    if (t.type === 'commission') dailyCommission += t.amount;
                            if (t.type === 'commission_discount' || t.type === 'owner_discount') {
                                // Track discounts separately
                                dailyDiscountTotal += Math.abs(t.amount);
                            }
                });


                expendituresSnap.forEach(doc => {
                    dailyExpenditureTotal += doc.data().amount;
                });

                // Prepare data for the chart (last 7 days)
                const labels = [];
                const incomeData = [];
                const expenditureData = [];
                        const discountData = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    labels.push(d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    incomeData.push(0);
                    expenditureData.push(0);
                            discountData.push(0);
                }

                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                sevenDaysAgo.setHours(0,0,0,0);
                const startTimestamp = Timestamp.fromDate(sevenDaysAgo);

                const [allTransactionsSnap, expenditureTxs] = await Promise.all([
                    db.collection('transactions').where('date', '>=', startTimestamp).get(),
                    db.collection('expenditures').where('date', '>=', startTimestamp).get()
                ]);

                const incomeDocs = allTransactionsSnap.docs.filter(doc => doc.data().type === 'income');
                        const discountDocs = allTransactionsSnap.docs.filter(doc => 
                            doc.data().type === 'commission_discount' || doc.data().type === 'owner_discount'
                        );

                const mapDateToValue = (docs) => {
                    const dateMap = {};
                    docs.forEach(doc => {
                        const date = doc.data().date.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        dateMap[date] = (dateMap[date] || 0) + doc.data().amount;
                    });
                    return dateMap;
                };

                        const mapDiscountDateToValue = (docs) => {
                            const dateMap = {};
                            docs.forEach(doc => {
                                const date = doc.data().date.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                // Discounts are negative amounts, so we add absolute value
                                dateMap[date] = (dateMap[date] || 0) + Math.abs(doc.data().amount);
                            });
                            return dateMap;
                        };

                const dailyIncomeMap = mapDateToValue(incomeDocs);
                const dailyExpenditureMap = mapDateToValue(expenditureTxs.docs);
                        const dailyDiscountMap = mapDiscountDateToValue(discountDocs);

                labels.forEach((label, index) => {
                    if (dailyIncomeMap[label]) incomeData[index] = dailyIncomeMap[label];
                    if (dailyExpenditureMap[label]) expenditureData[index] = dailyExpenditureMap[label];
                            if (dailyDiscountMap[label]) discountData[index] = dailyDiscountMap[label];
                });

                // Render daily data on the dashboard
                document.getElementById('dashboard-content').innerHTML = `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-gray-500">Daily Patients</h3><p class="text-3xl font-bold">${dailyPatients}</p></div>
                        <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-gray-500">Daily Income</h3><p class="text-3xl font-bold text-green-600">₹${dailyIncomeTotal.toLocaleString('en-IN')}</p></div>
                        <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-gray-500">Daily Commission</h3><p class="text-3xl font-bold text-orange-500">₹${dailyCommission.toLocaleString('en-IN')}</p></div>
                        <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-gray-500">Daily Expenditure</h3><p class="text-3xl font-bold text-red-600">₹${dailyExpenditureTotal.toLocaleString('en-IN')}</p></div>
                                <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-gray-500">Daily Discount</h3><p class="text-3xl font-bold text-purple-600">₹${dailyDiscountTotal.toLocaleString('en-IN')}</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Last 7 Days Financial Overview</h3>
                            <canvas id="financial-chart"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Last 30 Days - Daily Expenditure</h3>
                            <canvas id="expenditure-30-chart"></canvas>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Last 30 Days - Daily Patient Visits</h3>
                            <canvas id="patients-30-chart"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Last 30 Days - Daily Revenue</h3>
                            <canvas id="revenue-30-chart"></canvas>
                        </div>
                    </div>`;

                document.getElementById('dashboard-loader').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');

                // Ensure canvas elements are available before rendering charts
                const financialChartCanvas = document.getElementById('financial-chart');
                const expenditureChartCanvas = document.getElementById('expenditure-30-chart');
                const patientsChartCanvas = document.getElementById('patients-30-chart');
                const revenueChartCanvas = document.getElementById('revenue-30-chart');

                if (financialChartCanvas && expenditureChartCanvas && patientsChartCanvas && revenueChartCanvas) {
                    // Render Chart
                    const ctx = financialChartCanvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Income',
                                    data: incomeData,
                                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Expenditure',
                                    data: expenditureData,
                                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1
                                        },
                                        {
                                            label: 'Discount',
                                            data: discountData,
                                            backgroundColor: 'rgba(147, 51, 234, 0.6)',
                                            borderColor: 'rgba(147, 51, 234, 1)',
                                            borderWidth: 1
                                }
                            ]
                        },
                        options: { scales: { y: { beginAtZero: true } } }
                    });

                    // Prepare last 30 days labels
                    const labels30 = [];
                    const labelToIndex = {};
                    for (let i = 29; i >= 0; i--) {
                        const d = new Date();
                        d.setDate(d.getDate() - i);
                        const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        labels30.push(label);
                        labelToIndex[label] = labels30.length - 1;
                    }

                    const patientVisits = new Array(30).fill(0);
                    const revenue30 = new Array(30).fill(0);
                    const expenditure30 = new Array(30).fill(0);

                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    thirtyDaysAgo.setHours(0,0,0,0);
                    const start30Ts = Timestamp.fromDate(thirtyDaysAgo);

                    const [bills30Snap, income30Snap, expenditure30Snap] = await Promise.all([
                        db.collection('bills').where('createdAt', '>=', start30Ts).get(),
                        db.collection('transactions').where('date', '>=', start30Ts).get(),
                        db.collection('expenditures').where('date', '>=', start30Ts).get()
                    ]);

                    // Patient visits based on bills per day (count bills per day)
                    bills30Snap.forEach(doc => {
                        const b = doc.data();
                        const label = b.createdAt.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const idx = labelToIndex[label];
                        if (idx !== undefined) patientVisits[idx] += 1;
                    });

                    // Revenue from income transactions only
                    income30Snap.forEach(doc => {
                        const t = doc.data();
                        if (t.type !== 'income') return;
                        const label = t.date.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const idx = labelToIndex[label];
                        if (idx !== undefined) revenue30[idx] += Number(t.amount || 0);
                    });

                    // Expenditure per day
                    expenditure30Snap.forEach(doc => {
                        const e = doc.data();
                        if (!e.date) return;
                        const label = e.date.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const idx = labelToIndex[label];
                        if (idx !== undefined) expenditure30[idx] += Number(e.amount || 0);
                    });

                    // Render line charts
                    const patientsChartCtx = document.getElementById('patients-30-chart').getContext('2d');
                    new Chart(patientsChartCtx, {
                        type: 'line',
                        data: {
                            labels: labels30,
                            datasets: [{
                                label: 'Patients',
                                data: patientVisits,
                                tension: 0.3,
                                fill: false,
                                borderColor: '#2563eb',
                                backgroundColor: 'rgba(37, 99, 235, 0.2)',
                                pointRadius: 2
                            }]
                        },
                        options: { scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
                    });

                    const revenueChartCtx = document.getElementById('revenue-30-chart').getContext('2d');
                    new Chart(revenueChartCtx, {
                        type: 'line',
                        data: {
                            labels: labels30,
                            datasets: [{
                                label: 'Revenue (₹)',
                                data: revenue30,
                                tension: 0.3,
                                fill: false,
                                borderColor: '#059669',
                                backgroundColor: 'rgba(5, 150, 105, 0.2)',
                                pointRadius: 2
                            }]
                        },
                        options: { scales: { y: { beginAtZero: true } } }
                    });

                    const expenditureChartCtx = document.getElementById('expenditure-30-chart').getContext('2d');
                    new Chart(expenditureChartCtx, {
                        type: 'line',
                        data: {
                            labels: labels30,
                            datasets: [{
                                label: 'Expenditure (₹)',
                                data: expenditure30,
                                tension: 0.3,
                                fill: false,
                                borderColor: '#dc2626',
                                backgroundColor: 'rgba(220, 38, 38, 0.2)',
                                pointRadius: 2
                            }]
                        },
                        options: { scales: { y: { beginAtZero: true } } }
                    });

                } else {
                    console.error("Canvas elements not found for rendering charts.");
                }

            } catch (error) {
                console.error("Error loading dashboard:", error);
                document.getElementById('dashboard-loader').textContent = "Failed to load dashboard data.";
                showModal('Error', 'Failed to load dashboard data.');
            }
        }

        async function renderReportsPage() {
            const content = document.getElementById('page-content');
            content.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg space-y-6">
                    <h2 class="text-xl font-bold text-gray-800">Financial Reports</h2>
                    <div class="flex flex-wrap items-end gap-4 p-4 border rounded-lg bg-gray-50">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="start-date" class="mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="end-date" class="mt-1 p-2 border rounded-md">
                        </div>
                        <button id="generate-report-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md">Generate Report</button>
                    </div>
                    <div id="report-output">
                        <div id="report-container" class="overflow-x-auto">
                            <p class="text-center text-gray-500 py-8">Please select a date range and click "Generate Report" to view data.</p>
                        </div>
                    </div>
                </div>`;

            const generateBtn = document.getElementById('generate-report-btn');
            const reportContainer = document.getElementById('report-container');
            const reportOutput = document.getElementById('report-output');

            generateBtn.onclick = async () => {
                const startDateStr = document.getElementById('start-date').value;
                const endDateStr = document.getElementById('end-date').value;

                if (!startDateStr || !endDateStr) {
                    showModal('Invalid Input', 'Please select both a start and end date.');
                    return;
                }

                const startDate = new Date(startDateStr);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(endDateStr);
                endDate.setHours(23, 59, 59, 999);

                if (startDate > endDate) {
                     showModal('Invalid Input', 'Start date cannot be after the end date.');
                    return;
                }

                reportOutput.innerHTML = `<div id="report-container" class="overflow-x-auto"><div class="text-center py-10"><div class="spinner h-12 w-12 mx-auto border-4"></div><p class="mt-4">Fetching report data...</p></div></div>`;
                
                try {
                    const startTimestamp = Timestamp.fromDate(startDate);
                    const endTimestamp = Timestamp.fromDate(endDate);

                    const [billsSnap, expendituresSnap, allTransactionsSnap] = await Promise.all([
                        db.collection('bills').where('createdAt', '>=', startTimestamp).where('createdAt', '<=', endTimestamp).get(),
                        db.collection('expenditures').where('date', '>=', startTimestamp).where('date', '<=', endTimestamp).get(),
                        db.collection('transactions').where('date', '>=', startTimestamp).where('date', '<=', endTimestamp).get()
                    ]);
                    
                    const commissionsDocs = allTransactionsSnap.docs.filter(doc => doc.data().type === 'commission');
                    const dailyData = {};

                    billsSnap.docs.forEach(doc => {
                        const data = doc.data();
                        const dateStr = data.createdAt.toDate().toISOString().split('T')[0];
                                if (!dailyData[dateStr]) dailyData[dateStr] = { patients: new Set(), revenue: 0, refund: 0, expenditure: 0, commission: 0, cash: 0, upi: 0, discount: 0 };
                        dailyData[dateStr].patients.add(data.patientId);
                                
                                if (data.status === 'refunded') {
                                    // For refunded bills, add to refund amount
                                    dailyData[dateStr].refund += (Number(data.total) || 0);
                                } else {
                                    // For normal bills, add net revenue (after discount)
                        dailyData[dateStr].revenue += (Number(data.total) || 0);
                                    // Track discount separately
                                    dailyData[dateStr].discount += (Number(data.discountAmount) || 0);
                                    if (data.paymentMethod === 'cash') {
                                        dailyData[dateStr].cash += (Number(data.total) || 0);
                                    } else if (data.paymentMethod === 'upi') {
                                        dailyData[dateStr].upi += (Number(data.total) || 0);
                                    } else if (data.paymentMethod === 'both') {
                                        dailyData[dateStr].cash += (Number(data.cashAmount) || 0);
                                        dailyData[dateStr].upi += (Number(data.upiAmount) || 0);
                                    }
                                }
                    });

                    expendituresSnap.docs.forEach(doc => {
                         const data = doc.data();
                         const dateStr = data.date?.toDate().toISOString().split('T')[0];
                         if (dateStr) {
                                    if (!dailyData[dateStr]) dailyData[dateStr] = { patients: new Set(), revenue: 0, refund: 0, expenditure: 0, commission: 0, cash: 0, upi: 0, discount: 0 };
                            dailyData[dateStr].expenditure += (Number(data.amount) || 0);
                         }
                    });

                    commissionsDocs.forEach(doc => {
                        const data = doc.data();
                        const dateStr = data.date?.toDate().toISOString().split('T')[0];
                        if(dateStr) {
                                    if (!dailyData[dateStr]) dailyData[dateStr] = { patients: new Set(), revenue: 0, refund: 0, expenditure: 0, commission: 0, cash: 0, upi: 0, discount: 0 };
                            dailyData[dateStr].commission += (Number(data.amount) || 0);
                        }
                    });

                            // Note: Discounts are now tracked separately in the discount column, not in expenditure

                    const sortedDates = Object.keys(dailyData).sort();
                    if(sortedDates.length === 0) {
                        reportOutput.innerHTML = `<div id="report-container" class="overflow-x-auto"><p class="text-center text-gray-500 py-8">No data found for the selected date range.</p></div>`;
                        return;
                    }
                    
                    const reportTitle = `
                        <div class="flex justify-between items-center mb-4">
                           <h3 class="text-lg font-bold">Financial Report (from ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()})</h3>
                           <button id="download-report-btn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md">Download PDF</button>
                        </div>
                    `;

                    let tableHTML = `<table id="report-table" class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
                        <th class="px-6 py-3">Date</th>
                        <th class="px-6 py-3">Patients</th>
                        <th class="px-6 py-3">Revenue</th>
                                <th class="px-6 py-3">Discount</th>
                                <th class="px-6 py-3">Bill Refund</th>
                        <th class="px-6 py-3">Expenditure</th>
                        <th class="px-6 py-3">Commission</th>
                                <th class="px-6 py-3">Cash</th>
                                <th class="px-6 py-3">UPI</th>
                        <th class="px-6 py-3">Net Profit</th>
                    </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

                            let totalPatientsCount = 0, totalRevenue = 0, totalDiscount = 0, totalRefund = 0, totalExpenditure = 0, totalCommission = 0, totalCash = 0, totalUpi = 0;
                    sortedDates.forEach(dateStr => {
                        const data = dailyData[dateStr];
                        const netProfit = data.revenue - data.expenditure - data.commission;
                        totalPatientsCount += data.patients.size;
                        totalRevenue += data.revenue;
                                totalDiscount += data.discount;
                                totalRefund += data.refund;
                        totalExpenditure += data.expenditure;
                        totalCommission += data.commission;
                                totalCash += data.cash;
                                totalUpi += data.upi;
                        tableHTML += `<tr>
                                    <td class="px-6 py-4">${dateStr}</td>
                            <td class="px-6 py-4">${data.patients.size}</td>
                            <td class="px-6 py-4 text-green-600 font-semibold">₹${data.revenue.toFixed(2)}</td>
                                    <td class="px-6 py-4 text-orange-500 font-semibold">₹${data.discount.toFixed(2)}</td>
                                    <td class="px-6 py-4 text-red-500 font-semibold">₹${data.refund.toFixed(2)}</td>
                            <td class="px-6 py-4 text-red-600 font-semibold">₹${data.expenditure.toFixed(2)}</td>
                            <td class="px-6 py-4 text-orange-500 font-semibold">₹${data.commission.toFixed(2)}</td>
                                    <td class="px-6 py-4 text-blue-600 font-semibold">₹${data.cash.toFixed(2)}</td>
                                    <td class="px-6 py-4 text-blue-600 font-semibold">₹${data.upi.toFixed(2)}</td>
                            <td class="px-6 py-4 font-bold ${netProfit >= 0 ? 'text-blue-600' : 'text-red-700'}">₹${netProfit.toFixed(2)}</td>
                        </tr>`;
                    });
                            const totalNetProfit = totalRevenue - totalExpenditure - totalCommission;
                    tableHTML += `<tr class="bg-gray-100 font-bold">
                        <td class="px-6 py-4">Total</td>
                        <td class="px-6 py-4">${totalPatientsCount}</td>
                        <td class="px-6 py-4">₹${totalRevenue.toFixed(2)}</td>
                                <td class="px-6 py-4">₹${totalDiscount.toFixed(2)}</td>
                                <td class="px-6 py-4">₹${totalRefund.toFixed(2)}</td>
                        <td class="px-6 py-4">₹${totalExpenditure.toFixed(2)}</td>
                        <td class="px-6 py-4">₹${totalCommission.toFixed(2)}</td>
                                <td class="px-6 py-4">₹${totalCash.toFixed(2)}</td>
                                <td class="px-6 py-4">₹${totalUpi.toFixed(2)}</td>
                                <td class="px-6 py-4">₹${totalNetProfit.toFixed(2)}</td>
                    </tr>`;

                    tableHTML += `</tbody></table>`;

                    // Compose a dedicated A4-width container for clean export
                    let headerBlock = `
                        <div style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:16px;">
                            <div style="font-size:22px; font-weight:700; color:#000;">Perfect Diagnostic and Ultrasound Centre</div>
                            <div style="font-size:12px; margin-top:4px;">Kotwa bazar, Nebua Naurangiya Road, Minar Pul, Kotwa Kalan, Kushinagar, Uttar Pradesh, 274305</div>
                            <div style="font-size:12px; margin-top:2px;">Phone: +91 9838104111 , +91 9616434212 | Email: perfectdiagnostic@gmail.com</div>
                                    <div style="font-size:12px; margin-top:2px;">GSTIN: 09BHIPT2225A1ZK</div>
                        </div>`;

                    let reportHeading = `<div style="font-size:16px; font-weight:700; margin-bottom:12px;">Financial Report: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}</div>`;

                    let pdfRoot = `
                        <div id="report-pdf-root" style="width:800px; margin:0 auto; background:#ffffff; color:#333; font-family:sans-serif; padding:20px;">
                                                       ${headerBlock}
                            ${reportHeading}
                            <div style="overflow:hidden;">
                                <table style="width:100%; border-collapse:collapse; font-size:12px;">
                                    <thead>
                                        <tr style="background:#f3f4f6;">
                                            <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Date</th>
                                            <th style="text-align:right; padding:8px; border:1px solid #e5e7eb;">Patients</th>
                                            <th style="text-align:right; padding:8px; border:1px solid #e5e7eb;">Revenue</th>
                                            <th style="text-align:right; padding:8px; border:1px solid #e5e7eb;">Discount</th>
                                            <th style="text-align:right; padding:8px; border:1px solid #e5e7eb;">Bill Refund</th>
                                            <th style="text-align:right; padding:8px; border:1px solid #e5e7eb;">Expenditure</th>
                                            <th style="text-align:right; padding:8px; border:1px solid #e5e7eb;">Commission</th>
                                            <th style="text-align:right; padding:8px; border:1px solid #e5e7eb;">Cash</th>
                                            <th style="text-align:right; padding:8px; border:1px solid #e5e7eb;">UPI</th>
                                            <th style="text-align:right; padding:8px; border:1px solid #e5e7eb;">Net Profit</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    ${sortedDates.map(dateStr => {
                                        const data = dailyData[dateStr];
                                        const netProfit = data.revenue - data.expenditure - data.commission;
                                        return `<tr>
                                            <td style=\"padding:8px; border:1px solid #e5e7eb;\">${dateStr}</td>
                                            <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb;\">${data.patients.size}</td>
                                            <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb; color:#059669; font-weight:600;\">₹${data.revenue.toFixed(2)}</td>
                                            <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb; color:#ea580c; font-weight:600;\">₹${data.discount.toFixed(2)}</td>
                                            <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb; color:#dc2626; font-weight:600;\">₹${data.refund.toFixed(2)}</td>
                                            <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb; color:#dc2626; font-weight:600;\">₹${data.expenditure.toFixed(2)}</td>
                                            <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb; color:#ea580c; font-weight:600;\">₹${data.commission.toFixed(2)}</td>
                                            <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb; color:#2563eb; font-weight:600;\">₹${data.cash.toFixed(2)}</td>
                                            <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb; color:#2563eb; font-weight:600;\">₹${data.upi.toFixed(2)}</td>
                                            <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb; font-weight:700; color:${netProfit >= 0 ? '#2563eb' : '#b91c1c'};\">₹${netProfit.toFixed(2)}</td>
                                        </tr>`;
                                    }).join('')}
                                    <tr style=\"background:#f3f4f6; font-weight:700;\">
                                        <td style=\"padding:8px; border:1px solid #e5e7eb;\">Total</td>
                                        <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb;\">${totalPatientsCount}</td>
                                        <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb;\">₹${totalRevenue.toFixed(2)}</td>
                                        <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb;\">₹${totalDiscount.toFixed(2)}</td>
                                        <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb;\">₹${totalRefund.toFixed(2)}</td>
                                        <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb;\">₹${totalExpenditure.toFixed(2)}</td>
                                        <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb;\">₹${totalCommission.toFixed(2)}</td>
                                        <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb;\">₹${totalCash.toFixed(2)}</td>
                                        <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb;\">₹${totalUpi.toFixed(2)}</td>
                                        <td style=\"padding:8px; text-align:right; border:1px solid #e5e7eb;\">₹${totalNetProfit.toFixed(2)}</td>
                                    </tr>`;

                    reportOutput.innerHTML = reportTitle + `<div class="overflow-x-auto">${pdfRoot}</div>`;

                    document.getElementById('download-report-btn').onclick = () => {
                        const reportContent = document.getElementById('report-pdf-root');
                        if (reportContent) {
                            const { jsPDF } = window.jspdf;
                            html2canvas(reportContent, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
                                const imgData = canvas.toDataURL('image/png');
                                const pdf = new jsPDF('p', 'mm', 'a4');
                                const pdfWidth = pdf.internal.pageSize.getWidth();
                                const pdfHeight = (canvas.height * (pdfWidth - 20)) / canvas.width; // 10mm margin
                                pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, pdfHeight);
                                pdf.save(`financial_report_${startDateStr}_to_${endDateStr}.pdf`);
                            });
                        }
                    };
                } catch (error) {
                    console.error("Error generating report:", error);
                    reportOutput.innerHTML = `<div id="report-container" class="overflow-x-auto"><p class="text-center text-red-500 py-8">Failed to generate report. Please check the console.</p></div>`;
                }
            };
        }

        // ========================================================================
        // --- 9b. COMMISSION MANAGEMENT PAGE ---
        // ========================================================================
        async function renderCommissionManagementPage() {
            const content = document.getElementById('page-content');
            const currentYear = new Date().getFullYear();
            const years = Array.from({ length: 6 }, (_, i) => currentYear - i);
            const months = [
                'January','February','March','April','May','June','July','August','September','October','November','December'
            ];

            content.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg space-y-4">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Year</label>
                            <select id="cm-year" class="mt-1 p-2 border rounded-md">
                                ${years.map(y => `<option value="${y}" ${y===currentYear?'selected':''}>${y}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Month</label>
                            <select id="cm-month" class="mt-1 p-2 border rounded-md">
                                ${months.map((m, i) => `<option value="${i}">${m}</option>`).join('')}
                            </select>
                        </div>
                        <button id="cm-apply" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md">Apply</button>
                                <div class="flex flex-wrap gap-4">
                                    <div id="cm-total-card" class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200 min-w-[180px]">
                                        <div class="text-sm text-gray-600">Total Commission</div>
                                        <div id="cm-total-amount" class="text-2xl font-bold text-blue-600">₹0.00</div>
                                        <div id="cm-total-period" class="text-xs text-gray-500">September 2025</div>
                                    </div>
                                    <div id="cm-paid-card" class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200 min-w-[180px]">
                                        <div class="text-sm text-gray-600">Total Commission Paid</div>
                                        <div id="cm-paid-amount" class="text-2xl font-bold text-green-600">₹0.00</div>
                                        <div id="cm-paid-period" class="text-xs text-gray-500">September 2025</div>
                                    </div>
                                    <div id="cm-pending-card" class="bg-gradient-to-r from-orange-50 to-red-50 p-4 rounded-lg border border-orange-200 min-w-[180px]">
                                        <div class="text-sm text-gray-600">Total Left (Pending)</div>
                                        <div id="cm-pending-amount" class="text-2xl font-bold text-orange-600">₹0.00</div>
                                        <div id="cm-pending-period" class="text-xs text-gray-500">September 2025</div>
                                    </div>
                                    <div id="cm-patients-card" class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg border border-purple-200 min-w-[180px]">
                                        <div class="text-sm text-gray-600">Referred Patients</div>
                                        <div id="cm-patients-count" class="text-2xl font-bold text-purple-600">0/0</div>
                                        <div id="cm-patients-period" class="text-xs text-gray-500">September 2025</div>
                                    </div>
                                    <div id="cm-daily-paid-card" class="bg-gradient-to-r from-cyan-50 to-teal-50 p-4 rounded-lg border border-cyan-200 min-w-[180px]">
                                        <div class="text-sm text-gray-600">Daily Commission Paid</div>
                                        <div id="cm-daily-paid-amount" class="text-2xl font-bold text-cyan-600">₹0.00</div>
                                        <div id="cm-daily-paid-date" class="text-xs text-gray-500">Today</div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center py-4">
                                <div class="relative w-80">
                                    <input type="text" id="cm-search" placeholder="Search doctors..." class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left">Doctor</th>
                                    <th class="px-6 py-3 text-left">Location</th>
                                            <th class="px-6 py-3 text-right">Patient</th>
                                    <th class="px-6 py-3 text-right">Commission Earned</th>
                                    <th class="px-6 py-3 text-right">Commission Paid</th>
                                    <th class="px-6 py-3 text-right">Pending</th>
                                    <th class="px-6 py-3 text-left">Status</th>
                                    <th class="px-6 py-3 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cm-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>`;

            const applyBtn = document.getElementById('cm-apply');
            applyBtn.onclick = loadAndRender;
                    
                    // Add search functionality
                    document.getElementById('cm-search').addEventListener('input', (e) => {
                        renderCommissionTable();
                    });
                    
            await loadAndRender();

            async function loadAndRender() {
                const year = parseInt(document.getElementById('cm-year').value);
                const month = parseInt(document.getElementById('cm-month').value);
                const start = new Date(year, month, 1, 0, 0, 0, 0);
                const end = new Date(year, month + 1, 0, 23, 59, 59, 999);
                const startTs = Timestamp.fromDate(start);
                const endTs = Timestamp.fromDate(end);

                const [doctorsSnap, billsSnap, txSnap, paidMonthlySnap] = await Promise.all([
                    db.collection('doctors').get(),
                    db.collection('bills').where('createdAt', '>=', startTs).where('createdAt', '<=', endTs).get(),
                    db.collection('transactions').where('date', '>=', startTs).where('date', '<=', endTs).get(),
                    db.collection('commission_paid_monthly').where('year', '==', year).where('month', '==', month).get()
                ]);

                        window.doctorMap = new Map();
                doctorsSnap.forEach(doc => {
                    const d = doc.data();
                            window.doctorMap.set(doc.id, { id: doc.id, name: d.name || 'N/A', location: d.location || '—', percent: Number(d.commissionPercent || 0), earned: 0, paid: 0, patientCount: 0 });
                });

                        // Commission earned from bills in month (exclude refunded bills)
                billsSnap.forEach(doc => {
                    const b = doc.data();
                            if (b.status === 'refunded') return; // Skip refunded bills for commission calculation
                    if (!b.referredById) return;
                            const dm = window.doctorMap.get(b.referredById);
                    if (!dm) return;
                            
                            // Calculate commission from subtotal (before discount/GST)
                            const originalCommission = Number(b.subtotal || 0) * (dm.percent / 100);
                            // Apply discount deduction from commission
                            const discountAmount = Number(b.discountAmount || 0);
                            const finalCommission = Math.max(0, originalCommission - discountAmount);
                            
                            dm.earned += finalCommission;
                            console.log(`Commission for Dr. ${dm.name}: Bill subtotal=${b.subtotal}, Original Commission=${originalCommission}, Discount=${discountAmount}, Final Commission=${finalCommission}`);
                });

                // Commission paid: prefer admin-entered monthly totals (exact values)
                const monthlyPaidMap = new Map();
                paidMonthlySnap.forEach(doc => {
                    const d = doc.data();
                            monthlyPaidMap.set(d.doctorId, { totalPaid: Number(d.totalPaid || 0) });
                });
                        window.doctorMap.forEach((dm, id) => {
                    if (monthlyPaidMap.has(id)) {
                        const rec = monthlyPaidMap.get(id);
                        dm.paid = rec.totalPaid;
                    } else {
                        // Fallback: derive from transactions if no monthly record exists
                        dm.paid = 0;
                            }
                        });

                        // Count patients referred by each doctor
                        const patientSetMap = new Map();
                        billsSnap.forEach(doc => {
                            const b = doc.data();
                            if (b.status === 'refunded') return;
                            if (!b.referredById || !b.patientId) return;
                            if (!patientSetMap.has(b.referredById)) patientSetMap.set(b.referredById, new Set());
                            patientSetMap.get(b.referredById).add(b.patientId);
                        });
                        patientSetMap.forEach((set, docId) => {
                            if (window.doctorMap.has(docId)) window.doctorMap.get(docId).patientCount = set.size;
                        });

                        // Calculate totals for all cards
                        let totalCommission = 0;
                        let totalPaid = 0;
                        let totalPending = 0;
                        let totalReferredPatients = 0;
                        let totalPatients = 0;

                        window.doctorMap.forEach(d => {
                            totalCommission += d.earned;
                            totalPaid += d.paid;
                            totalPending += Math.max(0, d.earned - d.paid);
                            totalReferredPatients += d.patientCount;
                        });

                        // Calculate total patients for the month (from bills)
                        const totalPatientsSet = new Set();
                        billsSnap.forEach(doc => {
                            const bill = doc.data();
                            if (bill.patientId) {
                                totalPatientsSet.add(bill.patientId);
                            }
                        });
                        totalPatients = totalPatientsSet.size;

                        // Update all cards
                        const totalAmountEl = document.getElementById('cm-total-amount');
                        const totalPeriodEl = document.getElementById('cm-total-period');
                        if (totalAmountEl) totalAmountEl.textContent = `₹${totalCommission.toFixed(2)}`;
                        if (totalPeriodEl) totalPeriodEl.textContent = `${months[month]} ${year}`;

                        const paidAmountEl = document.getElementById('cm-paid-amount');
                        const paidPeriodEl = document.getElementById('cm-paid-period');
                        if (paidAmountEl) paidAmountEl.textContent = `₹${totalPaid.toFixed(2)}`;
                        if (paidPeriodEl) paidPeriodEl.textContent = `${months[month]} ${year}`;

                        const pendingAmountEl = document.getElementById('cm-pending-amount');
                        const pendingPeriodEl = document.getElementById('cm-pending-period');
                        if (pendingAmountEl) pendingAmountEl.textContent = `₹${totalPending.toFixed(2)}`;
                        if (pendingPeriodEl) pendingPeriodEl.textContent = `${months[month]} ${year}`;

                        const patientsCountEl = document.getElementById('cm-patients-count');
                        const patientsPeriodEl = document.getElementById('cm-patients-period');
                        if (patientsCountEl) patientsCountEl.textContent = `${totalReferredPatients}/${totalPatients}`;
                        if (patientsPeriodEl) patientsPeriodEl.textContent = `${months[month]} ${year}`;

                        // Calculate daily commission paid
                        const today = new Date();
                        const todayStr = today.toISOString().split('T')[0];
                        let dailyCommissionPaid = 0;
                        
                        // Get all commission payment records for current year
                        const currentYear = today.getFullYear();
                        const allCommissionPaidSnap = await db.collection('commission_paid_monthly')
                            .where('year', '==', currentYear)
                            .get();
                        
                        allCommissionPaidSnap.forEach(doc => {
                            const data = doc.data();
                            if (data.payments && Array.isArray(data.payments)) {
                                data.payments.forEach(payment => {
                                    const paymentDate = new Date(payment.date);
                                    const paymentDateStr = paymentDate.toISOString().split('T')[0];
                                    if (paymentDateStr === todayStr) {
                                        dailyCommissionPaid += Number(payment.amount) || 0;
                                    }
                                });
                            }
                        });
                        
                        // Update daily commission paid card
                        const dailyPaidAmountEl = document.getElementById('cm-daily-paid-amount');
                        const dailyPaidDateEl = document.getElementById('cm-daily-paid-date');
                        if (dailyPaidAmountEl) dailyPaidAmountEl.textContent = `₹${dailyCommissionPaid.toFixed(2)}`;
                        if (dailyPaidDateEl) dailyPaidDateEl.textContent = todayStr;

                        // Store all doctors for search functionality
                        window.allCommissionDoctors = Array.from(window.doctorMap.values());
                        
                        // Render table with current search filter
                        renderCommissionTable();
                    }

                    function renderCommissionTable() {
                        const searchTerm = document.getElementById('cm-search').value.toLowerCase();
                const tbody = document.getElementById('cm-body');
                tbody.innerHTML = '';
                        
                        let filteredDoctors = window.allCommissionDoctors || [];
                        if (searchTerm.trim()) {
                            filteredDoctors = filteredDoctors.filter(d => 
                                d.name.toLowerCase().includes(searchTerm) || 
                                d.location.toLowerCase().includes(searchTerm)
                            );
                        }
                        
                        filteredDoctors.forEach(d => {
                    const pending = Math.max(0, d.earned - d.paid);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4">${d.name}</td>
                        <td class="px-6 py-4">${d.location}</td>
                                <td class="px-6 py-4 text-right">${d.patientCount}</td>
                        <td class="px-6 py-4 text-right">₹${d.earned.toFixed(2)}</td>
                        <td class="px-6 py-4 text-right">₹${d.paid.toFixed(2)}</td>
                        <td class="px-6 py-4 text-right font-semibold ${pending>0?'text-orange-600':'text-green-700'}">₹${pending.toFixed(2)}</td>
                                <td class="px-6 py-4">${pending === 0 ? '<span class="px-2 py-1 rounded text-xs font-semibold bg-green-100 text-green-700">Fully Paid</span>' : '<span class="px-2 py-1 rounded text-xs font-semibold bg-orange-100 text-orange-700">Pending</span>'}</td>
                        <td class="px-6 py-4 space-x-3">
                                    <button data-id="${d.id}" class="cm-history text-indigo-600 font-semibold hover:underline">History</button>
                                    ${pending > 0 ? `<button data-id="${d.id}" data-earned="${d.earned}" data-pending="${pending}" class="cm-pay-amount text-green-600 font-semibold hover:underline">Pay Amount</button>` : '<span class="text-gray-400 text-sm">Fully Paid</span>'}
                        </td>`;
                    tbody.appendChild(tr);
                });

                        // Re-attach event listeners
                        tbody.querySelectorAll('.cm-pay-amount').forEach(btn => {
                            btn.onclick = () => promptPayAmount(btn.getAttribute('data-id'), parseFloat(btn.getAttribute('data-pending')||'0'));
                        });
                        tbody.querySelectorAll('.cm-history').forEach(btn => {
                            btn.onclick = async () => {
                                const doctorId = btn.getAttribute('data-id');
                                const y = parseInt(document.getElementById('cm-year').value), m = parseInt(document.getElementById('cm-month').value);
                                const key = `${doctorId}_${y}_${m}`;
                                const doc = await db.collection('commission_paid_monthly').doc(key).get();
                                const payments = doc.exists && doc.data().payments ? doc.data().payments : [];
                                
                                // Create proper HTML content
                                const container = document.createElement('div');
                                container.className = 'space-y-4';
                                
                                const title = document.createElement('h3');
                                title.className = 'font-bold text-lg mb-4';
                                title.textContent = 'Payment History';
                                container.appendChild(title);
                                
                                if (payments.length === 0) {
                                    const noPayments = document.createElement('p');
                                    noPayments.textContent = 'No payments yet.';
                                    container.appendChild(noPayments);
                                } else {
                                    const table = document.createElement('table');
                                    table.className = 'min-w-full text-sm border-collapse';
                                    
                                    const thead = document.createElement('thead');
                                    thead.innerHTML = '<tr class="bg-gray-50"><th class="px-3 py-2 text-left border">Date</th><th class="px-3 py-2 text-left border">Amount</th><th class="px-3 py-2 text-left border">By</th></tr>';
                                    table.appendChild(thead);
                                    
                                    const tbody = document.createElement('tbody');
                                    payments.forEach(p => {
                                        const row = document.createElement('tr');
                                        row.innerHTML = `<td class="px-3 py-2 border">${new Date(p.date).toLocaleString()}</td><td class="px-3 py-2 border">₹${p.amount.toFixed(2)}</td><td class="px-3 py-2 border">${p.by}</td>`;
                                        tbody.appendChild(row);
                                    });
                                    table.appendChild(tbody);
                                    container.appendChild(table);
                                }
                                
                                showModal('Payment History', '', [{ text: 'Close', class: 'bg-gray-500 hover:bg-gray-600', action: hideModal }]);
                                
                                // Inject the content into the modal
                                const msgEl = document.getElementById('generic-modal-message');
                                if (msgEl) { 
                                    msgEl.innerHTML = ''; 
                                    msgEl.appendChild(container); 
                                }
                            };
                        });

                        function promptPayAmount(doctorId, maxAmount) {
                            const container = document.createElement('div');
                            container.innerHTML = `<div class="space-y-3">
                                <label class="block text-sm">Amount (₹)</label>
                                <input id="cm-pay-amount" type="number" min="0.01" max="${maxAmount}" step="0.01" class="w-full p-2 border rounded-md" placeholder="0.00" />
                                <p class="text-sm text-gray-600">Maximum: ₹${maxAmount.toFixed(2)} (Pending Amount)</p>
                                <p class="text-sm text-blue-600">Enter amount between ₹0.01 and ₹${maxAmount.toFixed(2)}</p>
                            </div>`;
                            showModal('Pay Commission Amount', 'Enter amount to pay (cannot exceed pending amount).', [
                                { text: 'Cancel', class: 'bg-gray-500 hover:bg-gray-600', action: hideModal },
                                { text: 'Pay', class: 'bg-green-600 hover:bg-green-700', action: async () => {
                                    const inputEl = document.getElementById('cm-pay-amount');
                                    const inputValue = inputEl ? inputEl.value : '';
                                    const amt = parseFloat(inputValue) || 0;
                                    console.log('Payment attempt:', { 
                                        inputValue, 
                                        amt, 
                                        maxAmount, 
                                        isValid: amt > 0 && amt <= maxAmount,
                                        inputElement: inputEl
                                    });
                                    if (isNaN(amt) || amt <= 0) { 
                                        showModal('Invalid Amount', 'Please enter a valid amount greater than ₹0.00'); 
                                        return; 
                                    }
                                    if (amt > maxAmount) { 
                                        showModal('Amount Too High', `Amount cannot exceed pending amount of ₹${maxAmount.toFixed(2)}`); 
                                        return; 
                                    }
                                    
                                    // Update monthly aggregate doc
                                    const y = parseInt(document.getElementById('cm-year').value), m = parseInt(document.getElementById('cm-month').value);
                                    const key = `${doctorId}_${y}_${m}`;
                                    const docRef = db.collection('commission_paid_monthly').doc(key);
                                    await db.runTransaction(async t => {
                                        const snap = await t.get(docRef);
                                        const curr = snap.exists ? (snap.data().totalPaid || 0) : 0;
                                        const payments = snap.exists ? (snap.data().payments || []) : [];
                                        const user = auth.currentUser ? auth.currentUser.email : 'unknown';
                                        payments.push({ amount: amt, date: new Date().toISOString(), by: user });
                                        const newTotal = curr + amt;
                                        
                                        t.set(docRef, { 
                                            doctorId, 
                                            year: y, 
                                            month: m, 
                                            totalPaid: newTotal, 
                                            payments, 
                                            lastUpdated: new Date().toISOString()
                                        }, { merge: true });
                                    });
                                    await loadAndRender();
                                    showModal('Success', `Payment of ₹${amt.toFixed(2)} recorded successfully for Dr. ${window.doctorMap.get(doctorId)?.name || 'Unknown'}`);
                                }}
                            ]);
                            // Inject inputs into modal message area
                            const msgEl = document.getElementById('generic-modal-message');
                            if (msgEl) { 
                                msgEl.innerHTML = ''; 
                                msgEl.appendChild(container); 
                            }
                            
                            // Ensure the input is focusable and has proper attributes
                            setTimeout(() => {
                                const input = document.getElementById('cm-pay-amount');
                                if (input) {
                                    input.focus();
                                    input.select();
                                }
                            }, 100);
                        }

                function promptAddPaid(doctorId) {
                    const container = document.createElement('div');
                    container.innerHTML = `<div class="space-y-3"><label class="block text-sm">Amount (₹)</label><input id="cm-amount" type="number" min="0" class="w-full p-2 border rounded-md" placeholder="0"/></div>`;
                    showModal('Add Commission Paid', 'Enter amount to add as paid.', [
                        { text: 'Cancel', class: 'bg-gray-500 hover:bg-gray-600', action: hideModal },
                        { text: 'Add', class: 'bg-blue-600 hover:bg-blue-700', action: async () => {
                            const inputEl = container.querySelector('#cm-amount');
                            const amt = parseFloat(inputEl && inputEl.value ? inputEl.value : '0');
                            if (!(amt > 0)) { showModal('Invalid', 'Amount must be greater than 0'); return; }
                            // Update monthly aggregate doc
                            const y = parseInt(document.getElementById('cm-year').value), m = parseInt(document.getElementById('cm-month').value);
                            const key = `${doctorId}_${y}_${m}`;
                            const docRef = db.collection('commission_paid_monthly').doc(key);
                            await db.runTransaction(async t => {
                                const snap = await t.get(docRef);
                                const curr = snap.exists ? (snap.data().totalPaid || 0) : 0;
                                        const payments = snap.exists ? (snap.data().payments || []) : [];
                                        const user = auth.currentUser ? auth.currentUser.email : 'unknown';
                                        payments.push({ amount: amt, date: new Date().toISOString(), by: user });
                                        t.set(docRef, { doctorId, year: y, month: m, totalPaid: curr + amt, payments }, { merge: true });
                            });
                            await loadAndRender();
                        }}
                    ]);
                    // Inject inputs into modal message area
                    const msgEl = document.getElementById('generic-modal-message');
                    if (msgEl) { msgEl.innerHTML = ''; msgEl.appendChild(container.firstChild); }
                }

                        // Mark Paid function removed - no longer needed with simplified system

                        // PDF download removed per request
                    }
                }

                // ========================================================================
                // --- 9.5. TRANSACTIONS PAGE ---
                // ========================================================================
                async function renderTransactionsPage() {
                    const content = document.getElementById('page-content');
                    content.innerHTML = `
                        <div class="p-6">
                            <div class="mb-6">
                                <h1 class="text-2xl font-bold text-gray-900 mb-2">Daily Commission Transactions</h1>
                                <p class="text-gray-600">View commission payments by date with daily totals</p>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                                <div class="flex flex-wrap gap-4 items-end">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Date</label>
                                        <input type="date" id="transaction-date-filter" class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <button id="load-transactions-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold">Load Transactions</button>
                                    </div>
                                    <div>
                                        <button id="clear-transactions-filter" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 font-semibold">Clear Filter</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="transactions-content" class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 text-center text-gray-500">
                                    <p>Select a date and click "Load Transactions" to view commission payments</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Set today's date as default
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('transaction-date-filter').value = today;
                    
                    // Load today's transactions by default
                    loadTransactionsForDate(today);
                    
                    // Event listeners
                    document.getElementById('load-transactions-btn').onclick = () => {
                        const selectedDate = document.getElementById('transaction-date-filter').value;
                        if (selectedDate) {
                            loadTransactionsForDate(selectedDate);
                        } else {
                            showModal('Error', 'Please select a date first.');
                        }
                    };
                    
                    document.getElementById('clear-transactions-filter').onclick = () => {
                        document.getElementById('transaction-date-filter').value = '';
                        document.getElementById('transactions-content').innerHTML = `
                            <div class="p-6 text-center text-gray-500">
                                <p>Select a date and click "Load Transactions" to view commission payments</p>
                            </div>
                        `;
                    };
                }
                
                async function loadTransactionsForDate(selectedDate) {
                    const content = document.getElementById('transactions-content');
                    content.innerHTML = `
                        <div class="p-6 text-center">
                            <div class="spinner h-8 w-8 mx-auto border-4"></div>
                            <p class="mt-2 text-gray-600">Loading transactions...</p>
                        </div>
                    `;
                    
                    try {
                        const targetDate = new Date(selectedDate);
                        const startOfDay = new Date(targetDate);
                        startOfDay.setHours(0, 0, 0, 0);
                        const endOfDay = new Date(targetDate);
                        endOfDay.setHours(23, 59, 59, 999);
                        
                        // Search across all months to find the payment
                        const year = targetDate.getFullYear();
                        
                        // First try the specific month
                        const month = targetDate.getMonth() + 1;
                        let commissionPaidSnap = await db.collection('commission_paid_monthly')
                            .where('year', '==', year)
                            .where('month', '==', month)
                            .get();
                        
                        console.log(`Found ${commissionPaidSnap.docs.length} docs for ${year}-${month}`);
                        
                        // If no docs found, search all months for this year
                        if (commissionPaidSnap.docs.length === 0) {
                            console.log('No docs found for specific month, searching all months...');
                            commissionPaidSnap = await db.collection('commission_paid_monthly')
                                .where('year', '==', year)
                                .get();
                            console.log(`Found ${commissionPaidSnap.docs.length} docs for year ${year}`);
                        }
                        
                        console.log('Commission query debug:', {
                            year: year,
                            month: month,
                            selectedDate: selectedDate,
                            docsFound: commissionPaidSnap.docs.length,
                            targetDate: new Date(selectedDate).toISOString().split('T')[0]
                        });
                        
                        // Debug: Show what commission docs we found
                        commissionPaidSnap.docs.forEach((doc, index) => {
                            console.log(`Commission doc ${index + 1}:`, {
                                id: doc.id,
                                data: doc.data()
                            });
                        });
                        
                        let allPayments = [];
                        let dailyTotal = 0;
                        
                        commissionPaidSnap.forEach(doc => {
                            const data = doc.data();
                            console.log('Processing commission doc:', data);
                            if (data.payments && Array.isArray(data.payments)) {
                                console.log(`Found ${data.payments.length} payments in this doc`);
                                data.payments.forEach((payment, index) => {
                                    console.log(`Payment ${index + 1}:`, payment);
                                    const paymentDate = new Date(payment.date);
                                    const paymentDateStr = paymentDate.toISOString().split('T')[0];
                                    const targetDateStr = selectedDate;
                                    
                                    console.log('Payment check:', {
                                        originalDate: payment.date,
                                        paymentDate: paymentDate,
                                        paymentDateStr: paymentDateStr,
                                        targetDateStr: targetDateStr,
                                        matches: paymentDateStr === targetDateStr
                                    });
                                    
                                    // Only match if the payment date exactly matches the selected date
                                    if (paymentDateStr === targetDateStr) {
                                        console.log('✅ Payment matched!');
                                        allPayments.push({
                                            ...payment,
                                            doctorId: data.doctorId,
                                            doctorName: 'Loading...' // Will be filled below
                                        });
                                        dailyTotal += Number(payment.amount) || 0;
                                    } else {
                                        console.log('❌ Payment date does not match selected date');
                                    }
                                });
                            }
                        });
                        
                        // Get doctor names - fetch all doctors and create a map
                        const allDoctorsSnap = await db.collection('doctors').get();
                        const doctorMap = new Map();
                        allDoctorsSnap.forEach(doc => {
                            doctorMap.set(doc.id, doc.data().name);
                        });
                        
                        // Update payment data with doctor names
                        allPayments.forEach(payment => {
                            payment.doctorName = doctorMap.get(payment.doctorId) || 'Unknown Doctor';
                        });
                        
                        // Sort payments by time (most recent first)
                        allPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        if (allPayments.length === 0) {
                            content.innerHTML = `
                                <div class="p-6 text-center text-gray-500">
                                    <p>No commission payments found for ${selectedDate}</p>
                                </div>
                            `;
                        } else {
                            content.innerHTML = `
                                <div class="p-6">
                                    <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                        <h3 class="text-lg font-semibold text-blue-800">Daily Summary</h3>
                                        <p class="text-blue-600">Total Commission Paid: <span class="font-bold text-xl">₹${dailyTotal.toFixed(2)}</span></p>
                                        <p class="text-blue-600">Number of Payments: <span class="font-bold">${allPayments.length}</span></p>
                                    </div>
                                    
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Doctor</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid By</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                                                ${allPayments.map(payment => `
                                                    <tr class="hover:bg-gray-50">
                                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                            ${new Date(payment.date).toLocaleTimeString()}
                                                        </td>
                                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                            ${payment.doctorName}
                                                        </td>
                                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                            <span class="font-semibold text-green-600">₹${Number(payment.amount).toFixed(2)}</span>
                                                        </td>
                                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                            ${payment.by}
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error('Error loading transactions:', error);
                        console.error('Error details:', {
                            message: error.message,
                            code: error.code,
                            selectedDate: selectedDate
                        });
                        content.innerHTML = `
                            <div class="p-6 text-center text-red-500">
                                <p>Error loading transactions: ${error.message}</p>
                                <p class="text-sm mt-2">Please check the console for more details.</p>
                            </div>
                        `;
            }
        }

        // ========================================================================
        // --- 10. PDF GENERATION & PRINTING ---
        // ========================================================================
        async function generateAndDownloadPDF(billId, action = 'download') {
            const { jsPDF } = window.jspdf;
            const loaderId = 'pdf-loader';
            if (document.getElementById(loaderId)) return;

            const loader = document.createElement('div');
            loader.id = loaderId;
            loader.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]"><div class="spinner h-12 w-12 rounded-full border-4"></div><p class="text-white ml-4">Generating PDF...</p></div>`;
            document.body.appendChild(loader);

            try {
                const billDoc = await db.collection('bills').doc(billId).get();
                if (!billDoc.exists) throw new Error("Bill not found");
                
                const bill = billDoc.data();
                        let doctorName = 'N/A';
                        
                        // Check if we have a stored doctor name first (for "Other" doctors)
                        if (bill.referredByName) {
                            doctorName = bill.referredByName;
                        } else if (bill.referredById) {
                            // For existing doctors, fetch from database
                            const doctorDoc = await db.collection('doctors').doc(bill.referredById).get();
                            doctorName = doctorDoc.exists ? doctorDoc.data()?.name || 'N/A' : 'N/A';
                        } else {
                            // Self-referred case
                            doctorName = 'N/A';
                        }
                
                const patient = bill.patientDetails;

                const itemsHtml = bill.items.map((item, index) => `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px; text-align: center;">${index + 1}</td>
                        <td style="padding: 8px;">${item.name}</td>
                        <td style="padding: 8px; text-align: right;">${(item.price * item.quantity).toFixed(2)}</td>
                    </tr>`).join('');

                        const discountAmount = bill.discountAmount || 0;
                        const totalAfterDiscount = Math.max(0, bill.subtotal - discountAmount);
                const gstAmount = totalAfterDiscount * (bill.gstPercent / 100);

                const pdfHTML = `
                <div style="width: 800px; font-family: sans-serif; color: #333; background: white; padding: 20px;">
                    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
                        <h1 style="font-size: 28px; font-weight: bold; margin: 0; color: #000;">Perfect Diagnostic and Ultrasound Centre</h1>
                        <p style="margin: 5px 0; font-size: 14px;">Kotwa bazar, Nebua Naurangiya Road, Minar Pul, Kotwa Kalan, Kushinagar, Uttar Pradesh, 274305</p>
                        <p style="margin: 5px 0; font-size: 14px;">Phone: +91 9838104111, +91 9616434212 | Email: perfectdiagnostic@gmail.com</p>
                                <p style="margin: 5px 0; font-size: 14px;">GSTIN: 09BHIPT2225A1ZK</p>
                    </div>
                    <table style="width: 100%; margin-bottom: 20px; font-size: 14px; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 5px; vertical-align: top; width: 50%;">
                                <strong style="display: block; margin-bottom: 5px; font-size: 16px;">Patient Information</strong>
                                <strong>Name:</strong> ${patient.name}<br>
                                <strong>Age/Gender:</strong> ${patient.age || 'N/A'} Years / ${patient.gender}<br>
                                <strong>Mobile:</strong> ${patient.phone || 'N/A'}
                            </td>
                            <td style="padding: 5px; vertical-align: top; width: 50%; text-align: right;">
                                 <strong style="display: block; margin-bottom: 5px; font-size: 16px;">Bill Details</strong>
                                 <strong>Bill No:</strong> ${bill.billNumber}<br>
                                 <strong>Date:</strong> ${bill.createdAt.toDate().toLocaleDateString()}<br>
                                         <strong>Doctor Referred:</strong> ${doctorName === 'N/A' ? 'Self' : (doctorName.startsWith('Dr.') ? doctorName : `Dr. ${doctorName}`)}
                            </td>
                        </tr>
                    </table>
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 20px;">
                        <thead style="background-color: #f2f2f2;">
                            <tr>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">S.No</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Test Name</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">Price (INR)</th>
                            </tr>
                        </thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                    <div style="width: 40%; margin-left: 60%; font-size: 14px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px;">Subtotal:</td><td style="padding: 8px; text-align: right;">${bill.subtotal.toFixed(2)}</td></tr>
                                    <tr><td style="padding: 8px;">Discount (₹):</td><td style="padding: 8px; text-align: right;">- ${discountAmount.toFixed(2)}</td></tr>
                            <tr><td style="padding: 8px; border-bottom: 1px solid #ccc;">GST (${bill.gstPercent}%):</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #ccc;">+ ${gstAmount.toFixed(2)}</td></tr>
                            <tr style="font-weight: bold; font-size: 16px;"><td style="padding: 10px 8px;">Total:</td><td style="padding: 10px 8px; text-align: right;">${bill.total.toFixed(2)}</td></tr>
                        </table>
                    </div>
                    <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #777;">
                        <p>Thank you for choosing Perfect Diagnostic and Ultrasound Centre. For any queries, please contact us.</p>
                        <p style="font-style: italic;">This is a computer-generated bill and does not require a signature.</p>
                    </div>
                </div>`;
                
                // Create a temporary off-screen container (pattern used in report export)
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.width = '800px';
                tempContainer.style.background = '#ffffff';
                tempContainer.innerHTML = pdfHTML;
                document.body.appendChild(tempContainer);

                // Wait a frame for layout
                await new Promise(resolve => requestAnimationFrame(resolve));

                const canvas = await html2canvas(tempContainer, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });
                
                // Clean up DOM
                tempContainer.remove();

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * (pdfWidth - 20)) / canvas.width; // 10mm margin each side
                pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, pdfHeight);
                
                if (action === 'print') {
                    const blobUrl = pdf.output('bloburl');
                    const printWindow = window.open(blobUrl, '_blank');
                    if (printWindow) {
                        printWindow.addEventListener('load', () => {
                            printWindow.focus();
                            printWindow.print();
                        });
                    }
                } else {
                    pdf.save(`${bill.billNumber}_${patient.name.replace(/ /g, '_')}.pdf`);
                }

            } catch (error) {
                console.error("PDF Generation Error:", error);
                showModal('PDF Error', "Failed to generate PDF: " + error.message);
            } finally {
                document.getElementById(loaderId)?.remove();
            }
        }

        // ========================================================================
        // --- 11. DOCTOR COMMISSION PDF GENERATION ---
        // ========================================================================
        async function generateDoctorCommissionPDF(doctorName, bills, doctorsArray) {
            const { jsPDF } = window.jspdf;
            const loaderId = 'doctor-pdf-loader';
            if (document.getElementById(loaderId)) return;

            const loader = document.createElement('div');
            loader.id = loaderId;
            loader.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loader.innerHTML = '<div class="bg-white p-6 rounded-lg shadow-lg"><div class="spinner h-8 w-8 mx-auto border-4"></div><p class="mt-2 text-center">Generating PDF...</p></div>';
            document.body.appendChild(loader);

            try {
                // Calculate total commission using stored amounts
                let totalCommission = 0;
                bills.forEach(bill => {
                    const storedCommission = window.commissionMap.get(bill.id) || 0;
                    totalCommission += storedCommission;
                });

                const pdfHTML = `
                <div style="width: 800px; font-family: sans-serif; color: #333; background: white; padding: 20px;">
                    <div style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:16px;">
                        <div style="font-size:22px; font-weight:700; color:#000;">Perfect Diagnostic and Ultrasound Centre</div>
                        <div style="font-size:12px; margin-top:4px;">Kotwa bazar, Nebua Naurangiya Road, Minar Pul, Kotwa Kalan, Kushinagar, Uttar Pradesh, 274305</div>
                        <div style="font-size:12px; margin-top:2px;">Phone: +91 9838104111 , +91 9616434212 | Email: perfectdiagnostic@gmail.com</div>
                        <div style="font-size:12px; margin-top:2px;">GSTIN: 09BHIPT2225A1ZK</div>
                    </div>
                    
                    <div style="font-size:18px; font-weight:700; margin-bottom:20px; text-align:center;">
                        Doctor Commission Report: ${doctorName}
                    </div>
                    
                    <div style="font-size:12px; margin-bottom:20px; color:#666;">
                        Generated on: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}
                    </div>

                    <table style="width:100%; border-collapse:collapse; font-size:12px; margin-bottom:20px;">
                        <thead>
                            <tr style="background:#f3f4f6;">
                                <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Bill No</th>
                                <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Patient</th>
                                <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Ref Doc</th>
                                <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Date</th>
                                <th style="text-align:right; padding:8px; border:1px solid #e5e7eb;">Total</th>
                                <th style="text-align:right; padding:8px; border:1px solid #e5e7eb;">Commission</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bills.map(bill => {
                                let refDocName = 'Self';
                                let commissionAmount = 0;
                                
                                if (bill.referredByName) {
                                    refDocName = bill.referredByName;
                                } else if (bill.referredById) {
                                    const doctor = doctorsArray.find(d => d.id === bill.referredById);
                                    if (doctor) {
                                        refDocName = doctor.name;
                                    }
                                }
                                
                                // Get stored commission amount
                                commissionAmount = window.commissionMap.get(bill.id) || 0;
                                
                                return `
                                    <tr>
                                        <td style="padding:8px; border:1px solid #e5e7eb;">${bill.billNumber}</td>
                                        <td style="padding:8px; border:1px solid #e5e7eb;">${bill.patientDetails?.name || 'Unknown'}</td>
                                        <td style="padding:8px; border:1px solid #e5e7eb;">${refDocName}</td>
                                        <td style="padding:8px; border:1px solid #e5e7eb;">${bill.createdAt.toDate().toLocaleDateString()}</td>
                                        <td style="padding:8px; text-align:right; border:1px solid #e5e7eb;">₹${bill.total.toFixed(2)}</td>
                                        <td style="padding:8px; text-align:right; border:1px solid #e5e7eb;">₹${commissionAmount.toFixed(2)}</td>
                                    </tr>
                                `;
                            }).join('')}
                            <tr style="background:#f3f4f6; font-weight:700;">
                                <td style="padding:8px; border:1px solid #e5e7eb;" colspan="5">Total Commission:</td>
                                <td style="padding:8px; text-align:right; border:1px solid #e5e7eb;">₹${totalCommission.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #777;">
                        <p>This report shows all bills referred by ${doctorName} and their corresponding commission amounts.</p>
                        <p style="font-style: italic;">Generated by Perfect Diagnostic and Ultrasound Centre Management System</p>
                    </div>
                </div>`;

                // Create a temporary off-screen container
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.width = '800px';
                tempContainer.style.background = '#ffffff';
                tempContainer.innerHTML = pdfHTML;
                document.body.appendChild(tempContainer);

                // Wait a frame for layout
                await new Promise(resolve => requestAnimationFrame(resolve));

                const canvas = await html2canvas(tempContainer, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });
                
                // Clean up DOM
                tempContainer.remove();

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * (pdfWidth - 20)) / canvas.width;
                pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, pdfHeight);
                
                const fileName = `doctor_commission_${doctorName.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

            } catch (error) {
                console.error("Doctor Commission PDF Generation Error:", error);
                showModal('PDF Error', "Failed to generate PDF: " + error.message);
            } finally {
                document.getElementById(loaderId)?.remove();
            }
        }
        
        // --- Initial Render ---
        renderApp();
        
        // Function to show proof image in a modal
        window.showProofImage = function(imageUrl) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-4 max-w-4xl max-h-screen overflow-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Proof Image</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <img src="${imageUrl}" alt="Proof" class="max-w-full h-auto rounded">
                </div>
            `;
            document.body.appendChild(modal);
            // Close modal on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        };
            })
            .catch(error => {
                console.error('Failed to load Firebase config:', error);
                alert('Failed to load Firebase configuration. Please try again later.');
            });
    });
    </script>
</body>
</html>